<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WEBAPP PIANIFICAZIONE</title>

  <!-- Bootstrap 4.5.2 -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --tiffany:#0ABAB5;
      --tiffany2:#078f8a;
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 14px 34px rgba(15,23,42,.10);
      --radius:16px;

      --danger:#ef4444;
      --ok:#10b981;
      --warn:#f59e0b;

      --bottomH: 76px;
    }

    html,body{height:100%;}
    body{
      background: radial-gradient(1200px 600px at 20% -10%, rgba(10,186,181,.18), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(10,186,181,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-shell{ height:100%; display:flex; flex-direction:column; }

    .appbar{
      position: sticky;
      top: 0;
      z-index: 1030;
      background: linear-gradient(90deg, var(--tiffany), var(--tiffany2));
      color: #fff;
      padding: calc(10px + env(safe-area-inset-top)) 12px 10px;
      box-shadow: 0 10px 28px rgba(0,0,0,.12);
    }
    .appbar-compact{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand-title{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:16px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-sub{
      font-size:12.5px;
      opacity:.95;
      line-height:1.15;
      display:flex;
      align-items:baseline;
      gap:6px;
      flex-wrap:wrap;
    }
    .brand-sub .label{ opacity:.9; font-weight:900; }
    .brand-sub .value{
      font-weight:1000;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      padding: 3px 8px;
      border-radius: 999px;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .appbar-actions{ display:flex; align-items:center; gap:10px; }
    .am-select{
      height:36px;
      border-radius:12px;
      border: 1px solid rgba(255,255,255,.25) !important;
      background: rgba(255,255,255,.14) !important;
      color:#fff !important;
      min-width: 160px;
      max-width: 180px;
      font-weight:900;
      font-size:13px;
    }
    .btn-gear{
      width:40px;
      height:40px;
      border-radius:12px;
      border: 1px solid rgba(255,255,255,.30);
      background: rgba(255,255,255,.14);
      color:#fff;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .app-main{
      flex:1;
      overflow:auto;
      padding: 14px 14px calc(var(--bottomH) + 14px + env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
      position:relative;
    }

    /* Pull-to-refresh overlay */
    .ptr-indicator{
      position: sticky;
      top: 0;
      z-index: 2000;
      display:none;
      margin: -6px 0 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(10,186,181,.28);
      background: rgba(10,186,181,.12);
      color:#0f766e;
      font-weight:1000;
      font-size:13px;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .ptr-indicator.show{display:flex;}

    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0;
      height: calc(var(--bottomH) + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      border-top: 1px solid var(--border);
      box-shadow: 0 -10px 24px rgba(15,23,42,.08);
      z-index:1040;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
    }
    .bottom-nav .nav-pill{
      display:flex;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .bottom-nav button{
      flex:1;
      border:0;
      padding:12px 12px;
      font-weight:900;
      font-size:16px;
      background: transparent;
      color: #0f172a;
    }
    .bottom-nav button.active{
      background: rgba(10,186,181,.14);
      color:#0f766e;
      box-shadow: inset 0 0 0 1px rgba(10,186,181,.25);
    }

    .cardx{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardx-hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .cardx-bd{padding: 14px;}
    .muted{color:var(--muted);}
    .mini{font-size:12px;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .chip-ok{border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); color:#047857;}
    .chip-no{border-color: rgba(107,114,128,.25); background: rgba(107,114,128,.10); color:#374151;}
    .chip-tiffany{border-color: rgba(10,186,181,.35); background: rgba(10,186,181,.12); color:#0f766e;}

    .segmented{
      display:flex;
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .segmented button{
      flex:1;
      border:0;
      background:transparent;
      padding:10px 10px;
      font-weight:900;
    }
    .segmented button.active{
      background: rgba(10,186,181,.14);
      color:#0f766e;
      box-shadow: inset 0 0 0 1px rgba(10,186,181,.22);
    }

    .form-control, .custom-select{border-radius: 12px;}
    .btn{border-radius: 12px; font-weight:800;}
    .btn-primary{background: #0ea5a4; border-color:#0ea5a4;}
    .btn-primary:hover{background:#0b9a98; border-color:#0b9a98;}
    .btn-success{background:#16a34a; border-color:#16a34a;}
    .btn-success:hover{background:#15803d; border-color:#15803d;}
    .btn-danger{background:#ef4444; border-color:#ef4444;}
    .btn-danger:hover{background:#dc2626; border-color:#dc2626;}
    .btn-secondary{background:#64748b; border-color:#64748b;}
    .btn-secondary:hover{background:#475569; border-color:#475569;}

    .filters-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .filters-grid .full{grid-column: 1 / -1;}
    .shop-list{display:flex; flex-direction:column; gap:10px;}
    .shop-item{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .shop-item.coded-row{
      background: rgba(10,186,181,.10);
      border-color: rgba(10,186,181,.35);
      box-shadow: 0 10px 22px rgba(10,186,181,.12);
    }
    .shop-top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .shop-name{font-weight:900; font-size:15px; line-height:1.15; margin:0;}
    .shop-meta{margin-top:8px; font-size:13px; color:#334155; display:grid; grid-template-columns: 1fr; gap:4px;}
    .shop-meta .k{color:var(--muted); font-weight:800; font-size:12px; margin-right:6px;}
    .shop-actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
    .shop-actions .btn{padding:8px 10px; font-size:12px; border-radius: 12px;}

    .table-wrap{overflow:auto; border:1px solid var(--border); border-radius: 14px;}
    #clientTable{min-width: 860px; margin:0;}
    #clientTable thead th{white-space:nowrap;}
    #clientTable tbody tr.coded-row td{
      background: rgba(10,186,181,.10) !important;
    }

    .subtabs{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:4px;
      scrollbar-width: none;
    }
    .subtabs::-webkit-scrollbar{display:none;}
    .subtabs .tabbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight:900;
      white-space:nowrap;
      font-size:13px;
    }
    .subtabs .tabbtn.active{
      border-color: rgba(10,186,181,.35);
      background: rgba(10,186,181,.14);
      color:#0f766e;
    }

    .mini-controls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini-controls .custom-select{height:36px; font-weight:900; font-size:13px;}
    .mini-controls .btn{height:36px; padding:0 12px; font-size:12px;}
    .desktop-only{display:none;}

    .week-controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .week-controls .btn{font-size:12px; padding:10px 10px;}
    .week-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      touch-action: pan-y; /* permette swipe orizzontale senza bloccare scroll verticale */
    }
    .week-day{
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      box-shadow: 0 12px 26px rgba(15,23,42,.06);
      overflow:hidden;
    }
    .week-day-hd{
      padding: 10px 12px;
      background:#f8fafc;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:1000;
    }
    .week-day-hd .small{font-size:12px; color:#475569; font-weight:900;}
    .week-day-bd{ padding:10px 12px 12px; }

    .week-drop{
      min-height: 84px;
      overflow: visible;
      max-height: none;
      padding-right:0;
    }

    .week-day.today .week-day-hd{
      background: rgba(10,186,181,.18);
      color:#0f766e;
      border-bottom-color: rgba(10,186,181,.22);
    }

    .appointment-item{
      background:#fff;
      border:1px solid #cbd5e1;
      border-radius: 12px;
      padding: 7px 10px;
      margin-bottom:8px;
      font-size:13px;
      line-height:1.12;
      position:relative;
      cursor:move;
      user-select:none;
      white-space:normal;
      word-break:break-word;
    }
    .appointment-coded{
      background: linear-gradient(90deg, rgba(10,186,181,.92), rgba(7,143,138,.92));
      color:#fff;
      border-color: rgba(255,255,255,.22);
    }
    .delete-btn{
      float:right;
      cursor:pointer;
      color:#ef4444;
      font-weight:1000;
      margin-left:10px;
    }
    .appointment-coded .delete-btn{color: rgba(255,255,255,.92);}

    .droppable.over{outline:2px dashed rgba(14,165,164,.55); outline-offset:2px; border-radius: 10px;}

    .rank-card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .rank-card.coded-row{
      background: rgba(10,186,181,.10);
      border-color: rgba(10,186,181,.35);
    }
    .rank-table tbody tr.coded-row td{
      background: rgba(10,186,181,.10) !important;
    }

    /* ===== FIX CALENDARIO MODALI (BUG iPhone) ===== */
    #dayThumbnails, #moveDayThumbnails{
      margin-top: 6px;
    }
    .thumbs-hd{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      margin: 6px 0 8px;
      font-weight:1000;
      color:#0f172a;
      font-size:13px;
    }
    .thumbs-hd > div{
      text-align:center;
      color:#0f172a;
      font-weight:1000;
    }
    .thumbs-grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:6px;
    }
    .thumbs-grid > div{ /* spacer */
      height: 42px;
    }
    .thumbs-grid button{
      width:100%;
      height:42px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background:#f8fafc;
      font-weight:1000;
      color:#0f172a;
      padding:0;
      -webkit-appearance: none;
      appearance: none;
    }
    .thumbs-grid button:active{transform:scale(.98);}
    .thumbs-grid button.active{
      background: rgba(10,186,181,.18);
      border-color: rgba(10,186,181,.45);
      color:#0f766e;
      box-shadow: inset 0 0 0 1px rgba(10,186,181,.20);
    }

    @media (min-width: 992px){
      body{overflow:auto;}
      .app-main{padding-bottom: 24px;}
      .bottom-nav{display:none;}
      .week-grid{grid-template-columns: repeat(2, 1fr);}
      .desktop-only{display:inline-flex;}
    }
  </style>
</head>

<body>
<div class="app-shell">

  <header class="appbar">
    <div class="appbar-compact">
      <div class="brand">
        <div class="brand-title">WEBAPP PIANIFICAZIONE</div>
        <div class="brand-sub">
          <span class="label">Area Manager:</span>
          <span class="value" id="amLabel"></span>
        </div>
      </div>

      <div class="appbar-actions">
        <select id="managerSelect" class="custom-select am-select"></select>
        <button type="button" class="btn-gear" id="openSettingsBtn" aria-label="Impostazioni">⚙️</button>
      </div>
    </div>
  </header>

  <main class="app-main" id="appMain">
    <div class="ptr-indicator" id="ptrIndicator">AGGIORNA…</div>

    <div class="cardx mb-3">
      <div class="cardx-hd">
        <div class="d-flex align-items-center" style="gap:10px; flex-wrap:wrap;">
          <h4 class="mb-0" style="font-weight:1000;">Dashboard</h4>
          <span class="chip" id="yearChip">2025</span>
        </div>

        <div class="d-flex align-items-center" style="gap:10px;">
          <button class="btn btn-sm btn-outline-secondary" id="btnGoTodayTop">OGGI</button>
          <button class="btn btn-sm btn-success" id="sendScheduleBtnTop">INVIA</button>
        </div>
      </div>

      <div class="cardx-bd">
        <div class="segmented mb-3" id="topSegment">
          <button type="button" id="segPortafoglio" class="active">Portafoglio</button>
          <button type="button" id="segPianificazione">Pianificazione</button>
        </div>

        <!-- PORTAFOGLIO -->
        <section id="viewPortafoglio">
          <div class="cardx">
            <div class="cardx-hd">
              <div>
                <h5 style="font-weight:1000;">Portafoglio Negozi</h5>
                <div class="mini muted">Import Excel sovrascrive solo il portafoglio dell’AM selezionato (pianificazione invariata).</div>
              </div>
              <div class="d-flex" style="gap:8px; align-items:center; flex-wrap:wrap;">
                <span class="chip" id="shopsCountChip">0 negozi</span>
                <span class="chip chip-tiffany" id="codedCountChip">Codificati: 0</span>
                <span class="chip chip-no" id="toCodeCountChip">Da codificare: 0</span>
              </div>
            </div>

            <div class="cardx-bd">
              <div class="mb-3">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <strong>Importa Excel</strong><span class="mini muted">.xls/.xlsx</span>
                </div>
                <input type="file" id="importFile" accept=".xls,.xlsx" class="form-control-file">
              </div>

              <div class="cardx mb-3" style="box-shadow:none;">
                <div class="cardx-bd">
                  <h6 style="font-weight:1000;">Aggiungi negozio</h6>

                  <div class="form-group mb-2">
                    <label class="mini muted mb-1">Nome negozio</label>
                    <input type="text" id="newClientName" class="form-control" placeholder="Nome negozio">
                  </div>

                  <div class="form-group mb-2">
                    <label class="mini muted mb-1">Indirizzo</label>
                    <input type="text" id="newClientIndirizzo" class="form-control" placeholder="Indirizzo">
                  </div>

                  <div class="form-row">
                    <div class="col-6">
                      <label class="mini muted mb-1">Comune</label>
                      <input type="text" id="newClientComune" class="form-control" placeholder="Comune">
                    </div>
                    <div class="col-6">
                      <label class="mini muted mb-1">Città</label>
                      <input type="text" id="newClientCitta" class="form-control" placeholder="Città">
                    </div>
                  </div>

                  <div class="d-flex align-items-center justify-content-between mt-3" style="gap:10px;">
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="newClientCoded">
                      <label class="custom-control-label" for="newClientCoded" style="font-weight:900;">Codificato</label>
                    </div>

                    <button class="btn btn-primary" id="btnAddClient" style="min-width:140px;">Aggiungi</button>
                  </div>
                </div>
              </div>

              <div class="cardx mb-3" style="box-shadow:none;">
                <div class="cardx-bd">
                  <h6 style="font-weight:1000;">Filtri</h6>
                  <div class="filters-grid">
                    <div class="full">
                      <input type="text" id="filterName" class="form-control" placeholder="Filtra per nome">
                    </div>
                    <div class="full">
                      <input type="text" id="filterIndirizzo" class="form-control" placeholder="Filtra per indirizzo">
                    </div>
                    <div>
                      <input type="text" id="filterComune" class="form-control" placeholder="Filtra per comune">
                    </div>
                    <div>
                      <input type="text" id="filterCitta" class="form-control" placeholder="Filtra per città">
                    </div>
                    <div class="full">
                      <select id="filterCoded" class="custom-select">
                        <option value="">Tutti</option>
                        <option value="true">Codificati</option>
                        <option value="false">Non codificati</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-block d-lg-none">
                <div class="mini muted mb-2">Trascina un negozio sul calendario settimanale per pianificare.</div>
                <div id="shopList" class="shop-list"></div>
              </div>

              <div class="d-none d-lg-block">
                <div class="table-wrap">
                  <table class="table table-bordered" id="clientTable">
                    <thead class="thead-light">
                      <tr>
                        <th>Nome negozio</th>
                        <th>Indirizzo</th>
                        <th>Comune</th>
                        <th>Città</th>
                        <th>Codificato</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- PIANIFICAZIONE -->
        <section id="viewPianificazione" style="display:none;">
          <div class="cardx">
            <div class="cardx-hd">
              <div>
                <h5 style="font-weight:1000;">Pianificazione</h5>
                <div class="mini muted">Swipe sx/dx per cambiare settimana • Swipe giù per AGGIORNA.</div>
              </div>

              <div class="mini-controls">
                <select id="yearSelect" class="custom-select desktop-only" style="width:auto;">
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                </select>

                <select id="monthSelect" class="custom-select desktop-only" style="width:auto;"></select>

                <button class="btn btn-outline-secondary btn-sm" id="btnGoToday">OGGI</button>
                <button class="btn btn-success btn-sm" id="sendScheduleBtn">INVIA</button>
              </div>
            </div>

            <div class="cardx-bd">
              <div class="subtabs mb-3" id="planningTabs"></div>

              <div id="panelGenerale" class="planning-panel">
                <div class="d-flex align-items-center justify-content-between mb-2" style="gap:10px; flex-wrap:wrap;">
                  <div class="d-flex align-items-center" style="gap:10px; flex-wrap:wrap;">
                    <h6 class="mb-0" style="font-weight:1000;">Classifica Negozi</h6>
                    <span class="chip chip-tiffany" id="rankCodedChip">Codificati: 0</span>
                    <span class="chip chip-no" id="rankToCodeChip">Da codificare: 0</span>
                  </div>
                  <div class="d-flex align-items-center" style="gap:8px;">
                    <span class="mini muted" style="font-weight:900;">Filtro:</span>
                    <select id="rankingYearFilter" class="custom-select" style="width:auto;">
                      <option value="ALL">Tutti</option>
                      <option value="2025">Solo 2025</option>
                      <option value="2026">Solo 2026</option>
                    </select>
                  </div>
                </div>
                <div id="generalSummary"></div>
              </div>

              <div id="panelSettimana" class="planning-panel" style="display:none;">
                <div class="week-controls mb-2">
                  <div class="d-flex" style="gap:8px;">
                    <button class="btn btn-outline-secondary" id="prevWeekBtn">◀︎</button>
                    <button class="btn btn-outline-secondary" id="nextWeekBtn">▶︎</button>
                    <button class="btn btn-outline-secondary" id="todayWeekBtn">OGGI</button>
                  </div>
                  <div class="chip" id="weekLabel">Settimana</div>
                </div>
                <div id="weekGrid" class="week-grid"></div>
              </div>

              <div id="panelMese" class="planning-panel d-none d-lg-block" style="display:none;"></div>
            </div>
          </div>
        </section>

      </div>
    </div>

  </main>

  <nav class="bottom-nav d-lg-none">
    <div class="nav-pill">
      <button id="navPortafoglio" class="active" type="button">Portafoglio</button>
      <button id="navPianificazione" type="button">Pianificazione</button>
    </div>
  </nav>

</div>

<!-- MODAL: Pianifica -->
<div class="modal fade" id="scheduleModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document"><div class="modal-content">
    <form id="scheduleForm">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:1000;">Pianifica Visita</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label class="mini muted mb-1">Negozio</label>
          <input type="text" id="selectedClientName" class="form-control" readonly>
        </div>

        <div class="form-row">
          <div class="col-6">
            <label class="mini muted mb-1">Anno</label>
            <select id="scheduleYear" class="form-control" required>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div class="col-6">
            <label class="mini muted mb-1">Mese</label>
            <select id="scheduleMonth" class="form-control" required></select>
          </div>
        </div>

        <div class="mt-3">
          <label class="mini muted mb-1">Seleziona giorno</label>
          <div id="dayThumbnails"></div>
          <input type="hidden" id="scheduleDay" required>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Annulla</button>
        <button class="btn btn-primary">Conferma</button>
      </div>
    </form>
  </div></div>
</div>

<!-- MODAL: Sposta appuntamento -->
<div class="modal fade" id="moveModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document"><div class="modal-content">
    <form id="moveForm">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:1000;">Sposta appuntamento</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label class="mini muted mb-1">Negozio</label>
          <input type="text" id="moveClientName" class="form-control" readonly>
        </div>

        <div class="form-row">
          <div class="col-6">
            <label class="mini muted mb-1">Anno</label>
            <select id="moveYear" class="form-control" required>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div class="col-6">
            <label class="mini muted mb-1">Mese</label>
            <select id="moveMonth" class="form-control" required></select>
          </div>
        </div>

        <div class="mt-3">
          <label class="mini muted mb-1">Seleziona giorno</label>
          <div id="moveDayThumbnails"></div>
          <input type="hidden" id="moveDay" required>
          <div class="mini muted mt-2">Puoi spostarlo anche su un mese non visibile ora: viene salvato comunque.</div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Annulla</button>
        <button class="btn btn-primary">Sposta</button>
      </div>
    </form>
  </div></div>
</div>

<!-- MODAL: Settings -->
<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:1000;">Impostazioni</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        <div class="cardx" style="box-shadow:none;">
          <div class="cardx-bd">
            <div class="mini muted mb-2" style="font-weight:900;">Gestione Area Manager</div>

            <div class="form-group mb-2">
              <label class="mini muted mb-1">Nuovo AM</label>
              <input type="text" id="newManagerName" class="form-control" placeholder="Nuovo AM">
            </div>

            <div class="d-flex" style="gap:10px;">
              <button class="btn btn-outline-secondary flex-fill" onclick="addManager()">Aggiungi</button>
              <button class="btn btn-outline-secondary flex-fill" id="renameManagerBtn">Rinomina</button>
              <button class="btn btn-outline-secondary flex-fill" id="deleteManagerBtn">Elimina</button>
            </div>
          </div>
        </div>

        <div class="cardx mt-3" style="box-shadow:none;">
          <div class="cardx-bd">
            <div class="mini muted mb-2" style="font-weight:900;">Backup</div>
            <div class="d-flex" style="gap:10px;">
              <button class="btn btn-primary flex-fill" id="exportAllBtn">ESPORTA JSON</button>

              <label class="btn btn-outline-secondary flex-fill mb-0" style="display:flex;align-items:center;justify-content:center;cursor:pointer;">
                IMPORTA
                <input type="file" id="importAllFile" accept=".json" hidden>
              </label>
            </div>

            <div class="mini muted mt-2">
              Backup completo (AM + Portafogli + Pianificazioni).
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- jQuery, Popper, Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
  let currentManager = '';
  let currentClientId = null;

  const weekdays = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];

  const MONTHS_BY_YEAR = {
    2025: [
      { label: "Aprile",    monthNumber: 4 },
      { label: "Maggio",    monthNumber: 5 },
      { label: "Giugno",    monthNumber: 6 },
      { label: "Luglio",    monthNumber: 7 },
      { label: "Agosto",    monthNumber: 8 },
      { label: "Settembre", monthNumber: 9 },
      { label: "Ottobre",   monthNumber: 10 },
      { label: "Novembre",  monthNumber: 11 },
      { label: "Dicembre",  monthNumber: 12 }
    ],
    2026: [
      { label: "Gennaio",   monthNumber: 1 },
      { label: "Febbraio",  monthNumber: 2 },
      { label: "Marzo",     monthNumber: 3 },
      { label: "Aprile",    monthNumber: 4 },
      { label: "Maggio",    monthNumber: 5 },
      { label: "Giugno",    monthNumber: 6 },
      { label: "Luglio",    monthNumber: 7 },
      { label: "Agosto",    monthNumber: 8 },
      { label: "Settembre", monthNumber: 9 },
      { label: "Ottobre",   monthNumber: 10 },
      { label: "Novembre",  monthNumber: 11 },
      { label: "Dicembre",  monthNumber: 12 }
    ]
  };

  let selectedYear = 2025; // dropdown desktop
  let activeMonthNumber = null;
  let activePlanningTab = "generale"; // generale | settimana
  let weekStartDate = null; // Monday

  let moving = { name:"", coded:false, fromDate:"" };

  // ======= helpers =======
  function isDesktop(){ return window.matchMedia("(min-width: 992px)").matches; }
  function getTodayLocal(){ return new Date(); }
  function pad2(n){ return String(n).padStart(2,"0"); }

  // ISO storage key (stable)
  function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function parseISODate(iso){
    const [y,m,d]=iso.split("-").map(Number);
    return new Date(y, m-1, d);
  }

  // ✅ display DD-MM-YYYY
  function formatDDMMYYYYFromDate(d){
    return `${pad2(d.getDate())}-${pad2(d.getMonth()+1)}-${d.getFullYear()}`;
  }
  function formatDDMMYYYYFromISO(iso){
    const d = parseISODate(iso);
    return formatDDMMYYYYFromDate(d);
  }

  function startOfWeekMonday(date){
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const day = d.getDay(); // 0..6 (Sun..Sat)
    const diff = (day===0 ? -6 : 1-day);
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }
  function addDays(date, n){
    const d=new Date(date);
    d.setDate(d.getDate()+n);
    return d;
  }

  function normalizeActiveMonthForYear(year, desiredMonth){
    const list = MONTHS_BY_YEAR[year] || [];
    if(!list.length) return 1;
    const ok = list.some(m => m.monthNumber === desiredMonth);
    return ok ? desiredMonth : list[0].monthNumber;
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  // ========= STORAGE =========
  function getManagersList(){ return JSON.parse(localStorage.getItem("areaManagers")) || []; }
  function setManagersList(list){ localStorage.setItem("areaManagers", JSON.stringify(list)); }
  function clientsKey(mgr){ return "clientsData_" + mgr; }
  function appsKey(mgr){ return "appointmentsData_" + mgr; }

  function getClients(){
    return JSON.parse(localStorage.getItem(clientsKey(currentManager)))||[];
  }
  function setClients(arr){
    localStorage.setItem(clientsKey(currentManager), JSON.stringify(arr));
  }
  function getClientById(id){ return getClients().find(c=>c.id===id); }

  function getAppointments(){
    return JSON.parse(localStorage.getItem(appsKey(currentManager)))||{};
  }
  function setAppointments(obj){
    localStorage.setItem(appsKey(currentManager), JSON.stringify(obj));
  }

  // ========= AM UI =========
  function renderAmLabel(){
    document.getElementById("amLabel").textContent = currentManager || "-";
  }

  function loadManagers(){
    let list=getManagersList();
    if(!list.length){
      list=["MARIO ISERNIA"];
      setManagersList(list);
    }
    const sel=document.getElementById("managerSelect");
    sel.innerHTML="";
    list.forEach(m=>sel.add(new Option(m,m)));
    currentManager = sel.value;
    renderAmLabel();
  }

  // ========= AM CRUD =========
  function addManager(){
    const nm=document.getElementById("newManagerName").value.trim();
    if(!nm){ alert("Inserisci un nome."); return; }
    let list=getManagersList();
    if(list.includes(nm)){ alert("Esiste già."); return; }

    list.push(nm);
    setManagersList(list);

    loadManagers();
    document.getElementById("managerSelect").value=nm;
    currentManager=nm;
    renderAmLabel();

    document.getElementById("newManagerName").value="";
    reloadAll();
  }

  function renameManager(){
    const oldName=document.getElementById("managerSelect").value;
    if(!oldName){ alert("Seleziona un Area Manager."); return; }

    const newName=prompt("Nuovo nome Area Manager:", oldName);
    if(newName===null) return;
    const nn=newName.trim();
    if(!nn){ alert("Nome non valido."); return; }

    let list=getManagersList();
    if(nn!==oldName && list.includes(nn)){ alert("Esiste già."); return; }

    const ok=confirm(`Rinominare "${oldName}" in "${nn}"?\n\nVerranno mantenuti portafoglio e pianificazioni.`);
    if(!ok) return;

    const oldClients=localStorage.getItem(clientsKey(oldName));
    const oldApps=localStorage.getItem(appsKey(oldName));

    if(oldClients!==null) localStorage.setItem(clientsKey(nn), oldClients);
    if(oldApps!==null) localStorage.setItem(appsKey(nn), oldApps);

    localStorage.removeItem(clientsKey(oldName));
    localStorage.removeItem(appsKey(oldName));

    list=list.map(m=>(m===oldName?nn:m));
    setManagersList(list);

    if(currentManager===oldName) currentManager=nn;

    loadManagers();
    document.getElementById("managerSelect").value=nn;
    currentManager=nn;
    renderAmLabel();

    reloadAll();
  }

  function deleteManager(){
    const name=document.getElementById("managerSelect").value;
    if(!name){ alert("Seleziona un Area Manager."); return; }

    let list=getManagersList();
    if(list.length<=1){ alert("Non puoi eliminare l'ultimo Area Manager."); return; }

    const ok=confirm(`Eliminare "${name}"?\n\nATTENZIONE: verranno cancellati portafoglio e pianificazioni di questo Area Manager.`);
    if(!ok) return;

    localStorage.removeItem(clientsKey(name));
    localStorage.removeItem(appsKey(name));

    list=list.filter(m=>m!==name);
    setManagersList(list);

    if(currentManager===name) currentManager=list[0];

    loadManagers();
    document.getElementById("managerSelect").value=currentManager;
    renderAmLabel();

    reloadAll();
  }

  document.getElementById("renameManagerBtn").addEventListener("click", renameManager);
  document.getElementById("deleteManagerBtn").addEventListener("click", deleteManager);

  document.getElementById("managerSelect").addEventListener("change", ()=>{
    currentManager = document.getElementById("managerSelect").value;
    renderAmLabel();
    reloadAll();
  });

  // ========= BACKUP =========
  function buildBackupPayload(){
    const payload={
      app:"PIANIFICAZIONE_SETTIMANALE",
      version:"webapp-mobile-v2",
      exportedAt:new Date().toISOString(),
      keys:{}
    };
    const areaManagers=getManagersList();
    payload.keys["areaManagers"]=areaManagers;
    areaManagers.forEach(mgr=>{
      payload.keys[clientsKey(mgr)] = JSON.parse(localStorage.getItem(clientsKey(mgr)) || "null");
      payload.keys[appsKey(mgr)]    = JSON.parse(localStorage.getItem(appsKey(mgr)) || "null");
    });
    payload.keys["_lastManager"]=currentManager||"";
    return payload;
  }

  function downloadJson(filename,obj){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  document.getElementById("exportAllBtn").addEventListener("click", ()=>{
    const payload=buildBackupPayload();
    const stamp=new Date();
    const fn=`backup_webapp_pianificazione_${stamp.getFullYear()}-${pad2(stamp.getMonth()+1)}-${pad2(stamp.getDate())}.json`;
    downloadJson(fn,payload);
  });

  document.getElementById("importAllFile").addEventListener("change",(e)=>{
    const file=e.target.files && e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
      try{
        const obj=JSON.parse(ev.target.result);
        if(!obj || !obj.keys || obj.app!=="PIANIFICAZIONE_SETTIMANALE"){
          alert("File non valido o non compatibile.");
          return;
        }
        const ok=confirm("Importare il backup?\n\nSovrascrive i dati locali (Area Manager, Portafogli, Pianificazioni).");
        if(!ok) return;

        Object.entries(obj.keys).forEach(([k,v])=>{
          if(v===null || typeof v==="undefined") localStorage.removeItem(k);
          else localStorage.setItem(k, JSON.stringify(v));
        });

        loadManagers();
        const last=(obj.keys["_lastManager"]||"");
        if(last){
          document.getElementById("managerSelect").value=last;
          currentManager=last;
        } else {
          currentManager=document.getElementById("managerSelect").value;
        }
        renderAmLabel();

        weekStartDate = startOfWeekMonday(getTodayLocal());
        populateMonthSelect();
        rebuildPlanningTabs();
        renderActivePlanningPanel();
        reloadAll();

        alert("Backup importato correttamente.");
      }catch(err){
        console.error(err);
        alert("Errore: il file JSON non è leggibile.");
      }
    };
    reader.readAsText(file);
    e.target.value="";
  });

  // ========= NAV =========
  function showView(which){
    const isPort = which==="port";
    document.getElementById("viewPortafoglio").style.display = isPort ? "" : "none";
    document.getElementById("viewPianificazione").style.display = isPort ? "none" : "";

    document.getElementById("segPortafoglio").classList.toggle("active", isPort);
    document.getElementById("segPianificazione").classList.toggle("active", !isPort);

    document.getElementById("navPortafoglio").classList.toggle("active", isPort);
    document.getElementById("navPianificazione").classList.toggle("active", !isPort);

    if(!isPort){
      if(!isDesktop() && activePlanningTab==="mese") activePlanningTab="settimana";
      rebuildPlanningTabs();
      renderActivePlanningPanel();
      loadAppointmentsToViews();
      updateGeneralSummary();
    }
  }

  document.getElementById("segPortafoglio").addEventListener("click", ()=>showView("port"));
  document.getElementById("segPianificazione").addEventListener("click", ()=>showView("plan"));
  document.getElementById("navPortafoglio").addEventListener("click", ()=>showView("port"));
  document.getElementById("navPianificazione").addEventListener("click", ()=>showView("plan"));

  // ========= MONTH dropdown (desktop only) =========
  function populateMonthSelect(){
    const sel = document.getElementById("monthSelect");
    const list = MONTHS_BY_YEAR[selectedYear] || [];
    sel.innerHTML = "";
    list.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = String(m.monthNumber);
      opt.textContent = m.label;
      sel.appendChild(opt);
    });

    if(!activeMonthNumber){
      const t=getTodayLocal();
      activeMonthNumber = normalizeActiveMonthForYear(selectedYear, t.getMonth()+1);
    }
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, activeMonthNumber);
    sel.value = String(activeMonthNumber);
  }

  document.getElementById("yearSelect").addEventListener("change", ()=>{
    selectedYear=parseInt(document.getElementById("yearSelect").value,10) || selectedYear;
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, activeMonthNumber || (getTodayLocal().getMonth()+1));
    populateMonthSelect();
    syncYearChip();
  });

  document.getElementById("monthSelect").addEventListener("change", ()=>{
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, parseInt(document.getElementById("monthSelect").value,10));
  });

  function syncYearChip(){
    document.getElementById("yearChip").textContent = String(selectedYear);
    document.getElementById("yearSelect").value = String(selectedYear);
  }

  // ========= OGGI (collegato al calendario) =========
  function scrollTodayWeekIntoView(){
    const todayISO = toISODate(getTodayLocal());
    const el = document.querySelector(`.week-day[data-date="${todayISO}"]`);
    if(el){
      el.scrollIntoView({behavior:"smooth", block:"center", inline:"nearest"});
    }
  }

  function goTodayCalendar(){
    const t = getTodayLocal();
    weekStartDate = startOfWeekMonday(t);

    selectedYear = (t.getFullYear()===2025 || t.getFullYear()===2026) ? t.getFullYear() : 2026;
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, t.getMonth()+1);
    syncYearChip();
    populateMonthSelect();

    activatePlanningTab("settimana");
    renderActivePlanningPanel();
    loadAppointmentsToViews();
    updateGeneralSummary();
    setTimeout(scrollTodayWeekIntoView, 80);
  }

  document.getElementById("btnGoToday").addEventListener("click", goTodayCalendar);
  document.getElementById("todayWeekBtn").addEventListener("click", goTodayCalendar);

  document.getElementById("btnGoTodayTop").addEventListener("click", ()=>{
    showView("plan");
    goTodayCalendar();
  });

  // ========= IMPORT EXCEL =========
  document.getElementById("importFile").addEventListener("change", e=>{
    const f=e.target.files[0];
    if(!f) return;

    const r=new FileReader();
    r.onload=ev=>{
      const data=new Uint8Array(ev.target.result);
      const wb=XLSX.read(data,{type:"array"});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});

      localStorage.removeItem(clientsKey(currentManager));

      const arr=[];
      rows.forEach(rw=>{
        const name=String(rw["Nome negozio"]||"").trim();
        const indirizzo=String(rw["Indirizzo"]||"").trim();
        const comune=String(rw["Comune"]||"").trim();
        const citta=String(rw["Città"]||"").trim();
        const cv=String(rw["Codificato"]||"").trim().toUpperCase();
        const coded=(cv==="SI");

        if(!name && !indirizzo && !comune && !citta) return;
        arr.push({
          id:"client-"+Date.now()+"-"+Math.random(),
          name, indirizzo, comune, citta, coded
        });
      });

      arr.sort((a,b)=>a.name.localeCompare(b.name));
      localStorage.setItem(clientsKey(currentManager), JSON.stringify(arr));

      loadClients();
      updateGeneralSummary();
    };
    r.readAsArrayBuffer(f);
    e.target.value="";
  });

  // ========= FILTERS =========
  ["Name","Indirizzo","Comune","Citta"].forEach(k=>{
    document.getElementById("filter"+k).addEventListener("input", filterClientsAndRender);
  });
  document.getElementById("filterCoded").addEventListener("change", filterClientsAndRender);

  function getFilterState(){
    return {
      name: document.getElementById("filterName").value.toLowerCase(),
      indirizzo: document.getElementById("filterIndirizzo").value.toLowerCase(),
      comune: document.getElementById("filterComune").value.toLowerCase(),
      citta: document.getElementById("filterCitta").value.toLowerCase(),
      coded: document.getElementById("filterCoded").value
    };
  }
  function clientPassesFilter(c, f){
    let show=true;
    if(f.name && !String(c.name).toLowerCase().includes(f.name)) show=false;
    if(f.indirizzo && !String(c.indirizzo).toLowerCase().includes(f.indirizzo)) show=false;
    if(f.comune && !String(c.comune).toLowerCase().includes(f.comune)) show=false;
    if(f.citta && !String(c.citta).toLowerCase().includes(f.citta)) show=false;
    if(f.coded){
      const cd = c.coded ? "true" : "false";
      if(cd!==f.coded) show=false;
    }
    return show;
  }

  // ========= DRAG & DROP =========
  function dragStart(e){
    const t=e.currentTarget;
    if(t.classList.contains("appointment-item")){
      e.dataTransfer.setData("type","appointment");
      e.dataTransfer.setData("appointmentId", t.dataset.appId || t.id);
      e.dataTransfer.setData("fromDate", t.dataset.fromDate || "");
    } else {
      e.dataTransfer.setData("type","client");
      e.dataTransfer.setData("clientId", t.dataset.clientId);
    }
  }
  function allowDrop(e){
    e.preventDefault();
    e.currentTarget.classList.add("over");
  }
  function dragLeave(e){
    e.currentTarget.classList.remove("over");
  }

  function upsertAppointmentToStorage(dateISO, item){
    const data=getAppointments();
    const arr=data[dateISO] ? [...data[dateISO]] : [];
    if(arr.length>=8){ alert("Limite di 8 appuntamenti."); return; }
    arr.push({name:item.name, coded:!!item.coded});
    data[dateISO]=arr;
    setAppointments(data);
  }

  function removeAppointmentFromStorage(dateISO, name, coded){
    if(!dateISO) return;
    const data=getAppointments();
    const arr=data[dateISO] || [];
    const idx = arr.findIndex(x=>x.name===name && !!x.coded===!!coded);
    if(idx>=0) arr.splice(idx,1);
    if(arr.length) data[dateISO]=arr;
    else delete data[dateISO];
    setAppointments(data);
  }

  function dropToDate(dateISO, targetContainer){
    if(!dateISO) return;

    const currentCount = targetContainer.querySelectorAll(".appointment-item").length;
    if(currentCount>=8){ alert("Limite di 8 appuntamenti."); return; }

    const type = window._dndType;
    if(type==="client"){
      const id = window._dndClientId;
      const client = getClientById(id);
      if(!client) return;
      upsertAppointmentToStorage(dateISO, {name: client.name, coded: !!client.coded});
    } else if(type==="appointment"){
      const appId = window._dndAppId;
      const fromDate = window._dndFromDate;
      const appEl = document.querySelector(`[data-app-id="${cssEscape(appId)}"]`) || document.getElementById(appId);

      if(appEl){
        const name = appEl.dataset.name;
        const coded = (appEl.dataset.coded==="true");
        if(fromDate) removeAppointmentFromStorage(fromDate, name, coded);
        upsertAppointmentToStorage(dateISO, {name, coded});
      }
    }

    loadAppointmentsToViews();
    updateGeneralSummary();
  }

  function handleDrop(e){
    e.preventDefault();
    e.currentTarget.classList.remove("over");

    const dateISO = e.currentTarget.dataset.date;
    if(!dateISO) return;

    dropToDate(dateISO, e.currentTarget);
  }

  function createAppointmentEl(name, isCoded, fromDate){
    const div=document.createElement("div");
    const id="appointment-"+Date.now()+"-"+Math.random();

    div.id=id;
    div.dataset.appId = id;
    div.dataset.name=name;
    div.dataset.coded=isCoded ? "true" : "false";
    div.dataset.fromDate = fromDate || "";

    div.className="appointment-item" + (isCoded ? " appointment-coded" : "");
    div.draggable=true;
    div.addEventListener("dragstart", (e)=>{
      window._dndType="appointment";
      window._dndAppId=div.dataset.appId;
      window._dndFromDate=div.dataset.fromDate;
      dragStart(e);
    });

    div.addEventListener("click", (ev)=>{
      if(ev.target && ev.target.classList.contains("delete-btn")) return;
      openMoveModal(div.dataset.name, (div.dataset.coded==="true"), div.dataset.fromDate);
    });

    const span=document.createElement("span");
    span.textContent=name;
    div.appendChild(span);

    const del=document.createElement("span");
    del.className="delete-btn";
    del.innerHTML="&times;";
    del.onclick=(e)=>{
      e.stopPropagation();
      removeAppointmentFromStorage(div.dataset.fromDate, div.dataset.name, (div.dataset.coded==="true"));
      loadAppointmentsToViews();
      updateGeneralSummary();
    };
    div.appendChild(del);

    return div;
  }

  // ========= PORTAFOGLIO RENDER =========
  document.getElementById("btnAddClient").addEventListener("click", ()=>{
    const n=document.getElementById("newClientName").value.trim();
    const i=document.getElementById("newClientIndirizzo").value.trim();
    const c=document.getElementById("newClientComune").value.trim();
    const ct=document.getElementById("newClientCitta").value.trim();
    const cd=document.getElementById("newClientCoded").checked;

    if(!n || !i || !c || !ct){ alert("Compila tutti i campi."); return; }

    const arr=getClients();
    arr.push({ id:"client-"+Date.now()+"-"+Math.random(), name:n, indirizzo:i, comune:c, citta:ct, coded:cd });
    arr.sort((a,b)=>a.name.localeCompare(b.name));
    setClients(arr);

    ["newClientName","newClientIndirizzo","newClientComune","newClientCitta"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("newClientCoded").checked=false;

    loadClients();
    updateGeneralSummary();
  });

  function addClientRowDesktop(client){
    const tbody=document.querySelector("#clientTable tbody");
    const tr=document.createElement("tr");
    tr.dataset.clientId=client.id;
    tr.draggable=true;
    tr.addEventListener("dragstart", (e)=>{
      window._dndType="client";
      window._dndClientId=client.id;
      dragStart(e);
    });

    if(client.coded) tr.classList.add("coded-row");

    const tdName=document.createElement("td"); tdName.textContent=client.name; tr.appendChild(tdName);
    const tdInd=document.createElement("td"); tdInd.textContent=client.indirizzo; tr.appendChild(tdInd);
    const tdCom=document.createElement("td"); tdCom.textContent=client.comune; tr.appendChild(tdCom);
    const tdCit=document.createElement("td"); tdCit.textContent=client.citta; tr.appendChild(tdCit);

    const tdCoded=document.createElement("td");
    tdCoded.className="text-center";
    const chk=document.createElement("input");
    chk.type="checkbox"; chk.checked=!!client.coded;
    chk.onchange=()=>{
      const arr=getClients().map(x=>x.id===client.id ? {...x, coded:chk.checked} : x);
      setClients(arr);
      loadClients();
      updateGeneralSummary();
    };
    tdCoded.appendChild(chk);
    tr.appendChild(tdCoded);

    const tdAct=document.createElement("td");
    const btnEdit=document.createElement("button");
    btnEdit.className="btn btn-sm btn-secondary mr-1";
    btnEdit.textContent="Modifica";
    btnEdit.onclick=()=>editClient(client.id);

    const btnPlan=document.createElement("button");
    btnPlan.className="btn btn-sm btn-primary mr-1";
    btnPlan.textContent="Pianifica";
    btnPlan.onclick=()=>openScheduleModal(client.id);

    const btnDel=document.createElement("button");
    btnDel.className="btn btn-sm btn-danger";
    btnDel.textContent="Cancella";
    btnDel.onclick=()=>deleteClient(client.id);

    tdAct.appendChild(btnEdit);
    tdAct.appendChild(btnPlan);
    tdAct.appendChild(btnDel);
    tr.appendChild(tdAct);

    tbody.appendChild(tr);
  }

  function addClientCardMobile(client){
    const wrap=document.getElementById("shopList");
    const el=document.createElement("div");
    el.className="shop-item" + (client.coded ? " coded-row" : "");
    el.dataset.clientId=client.id;
    el.draggable=true;

    el.addEventListener("dragstart", (e)=>{
      window._dndType="client";
      window._dndClientId=client.id;
      dragStart(e);
    });

    const codedChip = client.coded
      ? `<span class="chip chip-tiffany">Codificato</span>`
      : `<span class="chip chip-no">Non codificato</span>`;

    el.innerHTML = `
      <div class="shop-top">
        <div style="min-width:0;">
          <p class="shop-name">${escapeHtml(client.name)}</p>
          <div class="mini muted" style="margin-top:6px;">Trascina per pianificare</div>
        </div>
        <div>${codedChip}</div>
      </div>

      <div class="shop-meta">
        <div><span class="k">Ind:</span>${escapeHtml(client.indirizzo)}</div>
        <div><span class="k">Comune:</span>${escapeHtml(client.comune)} <span class="k" style="margin-left:10px;">Città:</span>${escapeHtml(client.citta)}</div>
      </div>

      <div class="shop-actions">
        <button class="btn btn-secondary btn-sm" data-act="edit">Modifica</button>
        <button class="btn btn-primary btn-sm" data-act="plan">Pianifica</button>
        <button class="btn btn-outline-secondary btn-sm" data-act="toggle">${client.coded ? "Segna NON cod." : "Segna cod."}</button>
        <button class="btn btn-danger btn-sm" data-act="del">Cancella</button>
      </div>
    `;

    el.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        const act=b.dataset.act;
        if(act==="edit") editClient(client.id);
        if(act==="plan") openScheduleModal(client.id);
        if(act==="toggle"){
          const arr=getClients().map(x=>x.id===client.id ? {...x, coded:!x.coded} : x);
          setClients(arr);
          loadClients();
          updateGeneralSummary();
        }
        if(act==="del") deleteClient(client.id);
      });
    });

    wrap.appendChild(el);
  }

  function updatePortafoglioCounters(arr){
    const total = arr.length;
    const coded = arr.filter(x=>x.coded).length;
    const toCode = total - coded;

    document.getElementById("shopsCountChip").textContent = `${total} negozi`;
    document.getElementById("codedCountChip").textContent = `Codificati: ${coded}`;
    document.getElementById("toCodeCountChip").textContent = `Da codificare: ${toCode}`;

    document.getElementById("rankCodedChip").textContent = `Codificati: ${coded}`;
    document.getElementById("rankToCodeChip").textContent = `Da codificare: ${toCode}`;
  }

  function loadClients(){
    let arr=getClients();
    if(!arr.length){
      arr=[
        {id:"client-1",name:"Negozio A",indirizzo:"Via Roma 1",comune:"Centro",citta:"Milano",coded:false},
        {id:"client-2",name:"Negozio B",indirizzo:"Viale Europa 10",comune:"Periferia",citta:"Roma",coded:false}
      ];
      setClients(arr);
    }
    arr.sort((a,b)=>a.name.localeCompare(b.name));

    updatePortafoglioCounters(arr);

    const tbody=document.querySelector("#clientTable tbody");
    if(tbody) tbody.innerHTML="";
    arr.forEach(addClientRowDesktop);

    const list=document.getElementById("shopList");
    if(list) list.innerHTML="";
    const f=getFilterState();
    arr.filter(c=>clientPassesFilter(c,f)).forEach(addClientCardMobile);

    document.querySelectorAll("#clientTable tbody tr").forEach(tr=>{
      const id=tr.dataset.clientId;
      const c=arr.find(x=>x.id===id);
      tr.style.display = (c && clientPassesFilter(c,f)) ? "" : "none";
    });
  }

  function filterClientsAndRender(){ loadClients(); }

  function editClient(id){
    const arr=getClients();
    const c=arr.find(x=>x.id===id);
    if(!c) return;
    const nn=prompt("Modifica nome:", c.name);
    if(nn){
      c.name=nn.trim();
      setClients(arr);
      loadClients();
      updateGeneralSummary();
    }
  }

  function deleteClient(id){
    if(!confirm("Eliminare il negozio?")) return;
    const arr=getClients().filter(x=>x.id!==id);
    setClients(arr);
    loadClients();
    updateGeneralSummary();
  }

  // ========= PLANNING TABS =========
  function rebuildPlanningTabs(){
    const tabs=document.getElementById("planningTabs");
    tabs.innerHTML="";

    const desktop = isDesktop();

    const addTab=(key,label)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="tabbtn" + (activePlanningTab===key ? " active" : "");
      b.textContent=label;
      b.addEventListener("click", ()=>{
        activatePlanningTab(key);
        renderActivePlanningPanel();
        loadAppointmentsToViews();
        if(key==="settimana") setTimeout(scrollTodayWeekIntoView, 60);
      });
      tabs.appendChild(b);
    };

    addTab("generale","Generale");
    addTab("settimana","Settimana");

    if(!desktop && activePlanningTab==="mese"){
      activePlanningTab="settimana";
    }
  }

  function activatePlanningTab(key){
    if(!isDesktop() && key==="mese") key="settimana";
    activePlanningTab = key;
    rebuildPlanningTabs();
  }

  function renderActivePlanningPanel(){
    document.getElementById("panelGenerale").style.display = (activePlanningTab==="generale") ? "" : "none";
    document.getElementById("panelSettimana").style.display = (activePlanningTab==="settimana") ? "" : "none";

    if(activePlanningTab==="settimana"){
      renderWeekView();
      setTimeout(scrollTodayWeekIntoView, 60);
    }
    if(activePlanningTab==="generale"){
      updateGeneralSummary();
    }
  }

  // ========= WEEK VIEW RENDER =========
  function renderWeekView(){
    const grid=document.getElementById("weekGrid");
    grid.innerHTML="";

    const today=getTodayLocal();
    if(!weekStartDate) weekStartDate = startOfWeekMonday(today);

    const label=document.getElementById("weekLabel");
    const end = addDays(weekStartDate, 6);
    label.textContent = `${formatDDMMYYYYFromDate(weekStartDate)} → ${formatDDMMYYYYFromDate(end)}`;

    const todayISO = toISODate(today);

    for(let i=0;i<7;i++){
      const d=addDays(weekStartDate, i);
      const iso=toISODate(d);
      const wname=weekdays[i];

      const box=document.createElement("div");
      box.className="week-day";
      box.dataset.date = iso;
      if(iso===todayISO) box.classList.add("today");

      const hd=document.createElement("div");
      hd.className="week-day-hd";
      hd.innerHTML = `<div>${wname}</div><div class="small">${formatDDMMYYYYFromISO(iso)}</div>`;

      const bd=document.createElement("div");
      bd.className="week-day-bd";

      const drop=document.createElement("div");
      drop.className="week-drop droppable";
      drop.dataset.date=iso;

      drop.addEventListener("dragover", allowDrop);
      drop.addEventListener("dragleave", dragLeave);
      drop.addEventListener("drop", (e)=>{
        const type=e.dataTransfer.getData("type");
        if(type==="client"){
          window._dndType="client";
          window._dndClientId=e.dataTransfer.getData("clientId");
        } else {
          window._dndType="appointment";
          window._dndAppId=e.dataTransfer.getData("appointmentId");
          window._dndFromDate=e.dataTransfer.getData("fromDate");
        }
        handleDrop(e);
      });

      bd.appendChild(drop);
      box.appendChild(hd);
      box.appendChild(bd);
      grid.appendChild(box);
    }
  }

  document.getElementById("prevWeekBtn").addEventListener("click", ()=>{
    weekStartDate = addDays(weekStartDate, -7);
    renderWeekView();
    loadAppointmentsToViews();
  });
  document.getElementById("nextWeekBtn").addEventListener("click", ()=>{
    weekStartDate = addDays(weekStartDate, 7);
    renderWeekView();
    loadAppointmentsToViews();
  });

  // ========= SWIPE SX/DX: settimana =========
  function setupWeekSwipe(){
    const grid = document.getElementById("weekGrid");

    let sx=0, sy=0, ex=0, ey=0;
    let tracking=false;

    grid.addEventListener("touchstart", (e)=>{
      if(activePlanningTab!=="settimana") return;
      if(!e.touches || !e.touches.length) return;
      const t = e.touches[0];
      sx=t.clientX; sy=t.clientY;
      ex=sx; ey=sy;
      tracking=true;
    }, {passive:true});

    grid.addEventListener("touchmove", (e)=>{
      if(!tracking) return;
      const t = e.touches[0];
      ex=t.clientX; ey=t.clientY;
    }, {passive:true});

    grid.addEventListener("touchend", ()=>{
      if(!tracking) return;
      tracking=false;

      const dx = ex - sx;
      const dy = ey - sy;

      // gesture orizzontale “pulita”
      if(Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy)*1.2){
        if(dx < 0){
          // swipe left -> prossima settimana
          weekStartDate = addDays(weekStartDate, 7);
        } else {
          // swipe right -> settimana precedente
          weekStartDate = addDays(weekStartDate, -7);
        }
        renderWeekView();
        loadAppointmentsToViews();
      }
    }, {passive:true});
  }

  // ========= LOAD APPOINTMENTS into week view =========
  function clearAllAppointmentContainers(){
    document.querySelectorAll(".week-drop").forEach(c=>c.innerHTML="");
  }

  function loadAppointmentsToViews(){
    clearAllAppointmentContainers();
    const data=getAppointments();

    document.querySelectorAll(".week-drop[data-date]").forEach(drop=>{
      const iso=drop.dataset.date;
      const arr=data[iso]||[];
      arr.forEach(a=>{
        drop.appendChild(createAppointmentEl(a.name, !!a.coded, iso));
      });
    });
  }

  // ========= CLASSIFICA =========
  function updateGeneralSummary(){
    const rawData=getAppointments();
    const today=getTodayLocal();
    const filter=document.getElementById("rankingYearFilter").value;

    const filteredData={};
    Object.entries(rawData).forEach(([date,apps])=>{
      const y=parseInt(String(date).slice(0,4),10);
      if(filter!=="ALL" && y!==parseInt(filter,10)) return;
      filteredData[date]=apps;
    });

    const rankingObj={};
    Object.entries(filteredData).forEach(([date,apps])=>{
      const dt=new Date(date);
      apps.forEach(a=>{
        if(!rankingObj[a.name]) rankingObj[a.name]=[];
        rankingObj[a.name].push(dt);
      });
    });

    const clients=getClients();
    updatePortafoglioCounters(clients);

    const arr=clients.map(c=>{
      const dates=(rankingObj[c.name]||[]).sort((a,b)=>a-b);
      const past=dates.filter(d=>d<=today);
      const future=dates.filter(d=>d>today);

      let daysSinceLastVal=NaN;
      let daysSinceDisplay="-";
      if(past.length){
        const last=past[past.length-1];
        const diff=Math.round((today-last)/(1000*60*60*24));
        daysSinceLastVal=diff;
        daysSinceDisplay=diff+" giorni";
      }

      let progDisplay="-";
      if(future.length){
        const next=future[0];
        const missing=Math.round((next-today)/(1000*60*60*24));
        progDisplay=missing+" giorni";
      }

      const total=dates.length;
      const gap=total>1
        ? (dates.slice(1).reduce((s,d,i)=>s + Math.round((d-dates[i])/(1000*60*60*24)),0)/(total-1)).toFixed(1) + " giorni"
        : "N/A";

      const sortKey=isNaN(daysSinceLastVal) ? -Infinity : daysSinceLastVal;

      return { name:c.name, total, gap, coded:!!c.coded, daysSinceVal:sortKey, daysSinceDisplay, progDisplay };
    });

    const codedArr=arr.filter(x=>x.coded).sort((a,b)=>(b.daysSinceVal-a.daysSinceVal)||a.name.localeCompare(b.name));
    const nonArr=arr.filter(x=>!x.coded).sort((a,b)=>(b.daysSinceVal-a.daysSinceVal)||a.name.localeCompare(b.name));

    function renderCards(title, rows){
      return `
        <div class="cardx mb-3 d-block d-lg-none" style="box-shadow:none;">
          <div class="cardx-hd">
            <h6 style="font-weight:1000;margin:0;">${escapeHtml(title)}</h6>
            <span class="chip">${rows.length}</span>
          </div>
          <div class="cardx-bd" style="padding:12px;">
            <div style="display:flex;flex-direction:column;gap:10px;max-height:55dvh;overflow:auto;-webkit-overflow-scrolling:touch;">
              ${rows.map(r=>`
                <div class="rank-card ${r.coded ? "coded-row" : ""}">
                  <div style="font-weight:1000;font-size:14px;line-height:1.15;">${escapeHtml(r.name)}</div>
                  <div class="mini muted" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:10px;">
                    <span><b>Visite:</b> ${r.total}</span>
                    <span><b>Gap:</b> ${escapeHtml(r.gap)}</span>
                    <span><b>Programmata:</b> ${escapeHtml(String(r.progDisplay))}</span>
                    <span><b>Ultima:</b> ${escapeHtml(r.daysSinceDisplay)}</span>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        </div>
      `;
    }

    function renderTable(title, rows){
      let out=`<div class="cardx mb-3 d-none d-lg-block" style="box-shadow:none;">
        <div class="cardx-hd"><h6 style="font-weight:1000;margin:0;">${escapeHtml(title)}</h6></div>
        <div class="cardx-bd" style="padding:0;">
          <div class="table-wrap" style="border:0;border-radius:0;">
            <table class="table table-sm table-bordered mb-0 rank-table">
              <thead class="thead-light">
                <tr>
                  <th>Nome negozio</th>
                  <th>Visite</th>
                  <th>Gap medio</th>
                  <th>Programmata</th>
                  <th>Ultima visita</th>
                </tr>
              </thead>
              <tbody>`;
      rows.forEach(i=>{
        out += `<tr class="${i.coded ? "coded-row" : ""}">
          <td>${escapeHtml(i.name)}</td>
          <td>${i.total}</td>
          <td>${escapeHtml(i.gap)}</td>
          <td>${escapeHtml(String(i.progDisplay))}</td>
          <td>${escapeHtml(i.daysSinceDisplay)}</td>
        </tr>`;
      });
      out += `</tbody></table></div></div></div>`;
      return out;
    }

    const html =
      renderCards("Codificati", codedArr) +
      renderCards("Non codificati", nonArr) +
      renderTable("Codificati", codedArr) +
      renderTable("Non codificati", nonArr);

    document.getElementById("generalSummary").innerHTML=html;
  }

  document.getElementById("rankingYearFilter").addEventListener("change", updateGeneralSummary);

  // ========= MODAL: Pianifica / Sposta (Calendario FIX) =========
  function renderMonthSelectForYear(year, selectEl){
    selectEl.innerHTML=`<option value="">Seleziona</option>`;
    (MONTHS_BY_YEAR[year]||[]).forEach(m=>{
      const opt=document.createElement("option");
      opt.value=String(m.monthNumber);
      opt.textContent=m.label;
      selectEl.appendChild(opt);
    });
  }

  function daysInMonth(y,mIndex0){ return new Date(y,mIndex0+1,0).getDate(); }
  function weekdayMon0(y,mIndex0,d){ const w=new Date(y,mIndex0,d).getDay(); return w ? w-1 : 6; }

  function generateDayThumbnails(year, monthValue, containerEl, hiddenInputEl){
    containerEl.innerHTML="";
    hiddenInputEl.value="";
    if(!year || !monthValue) return;

    const hd=document.createElement("div");
    hd.className="thumbs-hd";
    weekdays.forEach(w=>{
      const d=document.createElement("div");
      d.textContent=w;
      hd.appendChild(d);
    });
    containerEl.appendChild(hd);

    const gd=document.createElement("div");
    gd.className="thumbs-grid";

    const mIndex0 = monthValue - 1;
    const total = daysInMonth(year, mIndex0);
    const first = weekdayMon0(year, mIndex0, 1);

    for(let i=0;i<first;i++){
      const spacer=document.createElement("div");
      gd.appendChild(spacer);
    }

    for(let d=1;d<=total;d++){
      const btn=document.createElement("button");
      btn.type="button";
      btn.textContent=d;
      btn.onclick=()=>{
        gd.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        hiddenInputEl.value=String(d);
      };
      gd.appendChild(btn);
    }
    containerEl.appendChild(gd);
  }

  function openScheduleModal(id){
    currentClientId=id;
    const client=getClientById(id);
    if(!client) return;

    document.getElementById("selectedClientName").value = client.name;

    const t=getTodayLocal();
    const y=(t.getFullYear()===2025||t.getFullYear()===2026)?t.getFullYear():2026;

    document.getElementById("scheduleYear").value = String(y);
    renderMonthSelectForYear(y, document.getElementById("scheduleMonth"));

    document.getElementById("scheduleMonth").value="";
    document.getElementById("dayThumbnails").innerHTML="";
    document.getElementById("scheduleDay").value="";

    $('#scheduleModal').modal('show');
  }

  document.getElementById("scheduleYear").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("scheduleYear").value,10);
    renderMonthSelectForYear(y, document.getElementById("scheduleMonth"));
    document.getElementById("dayThumbnails").innerHTML="";
    document.getElementById("scheduleDay").value="";
  });

  document.getElementById("scheduleMonth").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("scheduleYear").value,10);
    const mv=parseInt(document.getElementById("scheduleMonth").value,10);
    generateDayThumbnails(y, mv, document.getElementById("dayThumbnails"), document.getElementById("scheduleDay"));
  });

  document.getElementById("scheduleForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const y=parseInt(document.getElementById("scheduleYear").value,10);
    const mv=parseInt(document.getElementById("scheduleMonth").value,10);
    const dv=parseInt(document.getElementById("scheduleDay").value,10);

    if(!y||!mv||!dv){ alert("Compila tutti i campi."); return; }

    const dateISO = `${y}-${pad2(mv)}-${pad2(dv)}`;
    const client=getClientById(currentClientId);
    if(!client){ alert("Negozio non trovato."); return; }

    const data=getAppointments();
    const arr=data[dateISO]||[];
    if(arr.length>=8){ alert("Limite di 8 appuntamenti."); return; }

    upsertAppointmentToStorage(dateISO, {name: client.name, coded: !!client.coded});

    loadAppointmentsToViews();
    updateGeneralSummary();
    $('#scheduleModal').modal('hide');
  });

  function openMoveModal(name, coded, fromDate){
    moving = { name, coded, fromDate };

    document.getElementById("moveClientName").value = name;

    const d = fromDate ? parseISODate(fromDate) : getTodayLocal();
    const y = (d.getFullYear()===2025||d.getFullYear()===2026)?d.getFullYear():2026;
    const m = d.getMonth()+1;
    const day = d.getDate();

    document.getElementById("moveYear").value = String(y);
    renderMonthSelectForYear(y, document.getElementById("moveMonth"));
    document.getElementById("moveMonth").value = String(m);

    generateDayThumbnails(y, m, document.getElementById("moveDayThumbnails"), document.getElementById("moveDay"));

    document.getElementById("moveDay").value = String(day);
    setTimeout(()=>{
      const grid=document.querySelector("#moveDayThumbnails .thumbs-grid");
      if(grid){
        const btns=[...grid.querySelectorAll("button")];
        btns.forEach(b=>b.classList.toggle("active", b.textContent===String(day)));
      }
    }, 0);

    $('#moveModal').modal('show');
  }

  document.getElementById("openSettingsBtn").addEventListener("click", () => {
    $('#settingsModal').modal('show');
  });

  document.getElementById("moveYear").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("moveYear").value,10);
    renderMonthSelectForYear(y, document.getElementById("moveMonth"));
    document.getElementById("moveDayThumbnails").innerHTML="";
    document.getElementById("moveDay").value="";
  });

  document.getElementById("moveMonth").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("moveYear").value,10);
    const mv=parseInt(document.getElementById("moveMonth").value,10);
    generateDayThumbnails(y, mv, document.getElementById("moveDayThumbnails"), document.getElementById("moveDay"));
  });

  document.getElementById("moveForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const y=parseInt(document.getElementById("moveYear").value,10);
    const mv=parseInt(document.getElementById("moveMonth").value,10);
    const dv=parseInt(document.getElementById("moveDay").value,10);

    if(!y||!mv||!dv){ alert("Compila tutti i campi."); return; }

    const toDate = `${y}-${pad2(mv)}-${pad2(dv)}`;
    const data=getAppointments();
    const targetArr=data[toDate]||[];
    if(targetArr.length>=8){ alert("Limite di 8 appuntamenti."); return; }

    removeAppointmentFromStorage(moving.fromDate, moving.name, moving.coded);
    upsertAppointmentToStorage(toDate, {name:moving.name, coded:moving.coded});

    loadAppointmentsToViews();
    updateGeneralSummary();
    $('#moveModal').modal('hide');
  });

  // ========= INVIO (mail) =========
  function buildMailFromCurrentView(){
    let subj="", body="";

    if(activePlanningTab==="generale"){
      subj = `Pianificazione - Classifica ${currentManager}`;
      body = document.getElementById("generalSummary").innerText.trim();
      return {subj, body};
    }

    subj = `Pianificazione Settimana - ${document.getElementById("weekLabel").innerText} - ${currentManager}`;
    const data=getAppointments();
    const lines=[];
    for(let i=0;i<7;i++){
      const d=addDays(weekStartDate, i);
      const iso=toISODate(d);
      const arr=data[iso]||[];
      if(arr.length){
        lines.push(`${formatDDMMYYYYFromISO(iso)}: ${arr.map(x=>x.name).join(", ")}`);
      }
    }
    body = lines.length ? lines.join("\n") : "Nessuna pianificazione presente in questa settimana.";
    return {subj, body};
  }

  function sendMail(){
    const {subj, body} = buildMailFromCurrentView();
    window.location.href=`mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  }

  document.getElementById("sendScheduleBtn").addEventListener("click", sendMail);
  document.getElementById("sendScheduleBtnTop").addEventListener("click", ()=>{
    showView("plan");
    sendMail();
  });

  // ========= CSS escape helper =========
  function cssEscape(s){
    return String(s).replace(/([!"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~])/g,'\\$1');
  }

  // ========= REFRESH (Pull-to-refresh) =========
  function setupPullToRefresh(){
    const main = document.getElementById("appMain");
    const indicator = document.getElementById("ptrIndicator");

    let startY=0, startX=0;
    let pulling=false;
    let armed=false;

    function canPTR(){
      // solo quando sei in pianificazione + settimana o generale (app fluida)
      const planVisible = document.getElementById("viewPianificazione").style.display !== "none";
      if(!planVisible) return false;
      if(main.scrollTop > 0) return false;
      // evita quando modale aperta
      if(document.body.classList.contains("modal-open")) return false;
      return true;
    }

    main.addEventListener("touchstart", (e)=>{
      if(!canPTR()) return;
      if(!e.touches || !e.touches.length) return;
      const t=e.touches[0];
      startY=t.clientY;
      startX=t.clientX;
      pulling=true;
      armed=false;
    }, {passive:true});

    main.addEventListener("touchmove", (e)=>{
      if(!pulling) return;
      if(!canPTR()) { pulling=false; return; }
      const t=e.touches[0];
      const dy = t.clientY - startY;
      const dx = t.clientX - startX;

      // deve essere principalmente verticale verso il basso
      if(dy > 25 && Math.abs(dy) > Math.abs(dx) * 1.3){
        indicator.classList.add("show");
        armed = dy > 70;
      } else if(dy < 10){
        indicator.classList.remove("show");
        armed = false;
      }
    }, {passive:true});

    main.addEventListener("touchend", ()=>{
      if(!pulling) return;
      pulling=false;

      if(armed){
        // refresh “soft”
        indicator.textContent = "AGGIORNA…";
        setTimeout(()=>{
          reloadAll();
          indicator.textContent = "AGGIORNATO ✅";
          setTimeout(()=>indicator.classList.remove("show"), 650);
        }, 100);
      } else {
        indicator.classList.remove("show");
      }
    }, {passive:true});
  }

  // ========= INIT / RELOAD =========
  function reloadAll(){
    renderAmLabel();
    loadClients();

    rebuildPlanningTabs();
    renderActivePlanningPanel();
    loadAppointmentsToViews();
    updateGeneralSummary();
  }

  // ========= INIT =========
  document.addEventListener("DOMContentLoaded", ()=>{
    loadManagers();
    document.getElementById("managerSelect").value = currentManager;
    renderAmLabel();

    const today=getTodayLocal();
    weekStartDate = startOfWeekMonday(today);

    selectedYear = (today.getFullYear()===2025 || today.getFullYear()===2026) ? today.getFullYear() : 2026;
    document.getElementById("yearSelect").value = String(selectedYear);
    syncYearChip();

    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, today.getMonth()+1);
    populateMonthSelect();

    document.getElementById("scheduleYear").value=String(selectedYear);
    renderMonthSelectForYear(selectedYear, document.getElementById("scheduleMonth"));

    document.getElementById("moveYear").value=String(selectedYear);
    renderMonthSelectForYear(selectedYear, document.getElementById("moveMonth"));

    showView("port");
    reloadAll();

    // gesture init
    setupWeekSwipe();
    setupPullToRefresh();

    window.addEventListener("resize", ()=>{
      if(!isDesktop() && activePlanningTab==="mese") activePlanningTab="settimana";
      rebuildPlanningTabs();
    });
  });
</script>
</body>
</html>
