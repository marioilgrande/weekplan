<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WEBAPP PIANIFICAZIONE</title>

  <!-- Bootstrap 4.5.2 -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --tiffany:#0ABAB5;
      --tiffany2:#078f8a;
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 14px 34px rgba(15,23,42,.10);
      --radius:16px;

      --danger:#ef4444;
      --ok:#10b981;
      --warn:#f59e0b;

      --appbarH: 86px;
      --bottomH: 76px;
    }

    html,body{height:100%;}
    body{
      background: radial-gradient(1200px 600px at 20% -10%, rgba(10,186,181,.18), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(10,186,181,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden; /* scroll gestito solo nel main */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== APP SHELL ===== */
    .app-shell{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    /* Header compatta */
    .appbar{
      position: sticky;
      top: 0;
      z-index: 1030;
      background: linear-gradient(90deg, var(--tiffany), var(--tiffany2));
      color: #fff;
      padding: calc(10px + env(safe-area-inset-top)) 12px 10px;
      box-shadow: 0 10px 28px rgba(0,0,0,.12);
    }
    .appbar-compact{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand-title{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:16px;
      line-height:1.1;
    }
    .brand-sub{ font-size:12px; opacity:.92; margin-top:4px; }
    .appbar-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .am-select{
      height:36px;
      border-radius:12px;
      border: 1px solid rgba(255,255,255,.25) !important;
      background: rgba(255,255,255,.14) !important;
      color:#fff !important;
      min-width: 160px;
      max-width: 180px;
      font-weight:900;
      font-size:13px;
    }

    .btn-gear{
      width:40px;
      height:40px;
      border-radius:12px;
      border: 1px solid rgba(255,255,255,.30);
      background: rgba(255,255,255,.14);
      color:#fff;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .app-main{
      flex:1;
      overflow:auto;
      padding: 14px 14px calc(var(--bottomH) + 14px + env(safe-area-inset-bottom));
    }

    /* ===== BOTTOM NAV ===== */
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0;
      height: calc(var(--bottomH) + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      border-top: 1px solid var(--border);
      box-shadow: 0 -10px 24px rgba(15,23,42,.08);
      z-index:1040;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
    }
    .bottom-nav .nav-pill{
      display:flex;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .bottom-nav button{
      flex:1;
      border:0;
      padding:12px 12px;
      font-weight:900;
      font-size:16px;
      background: transparent;
      color: #0f172a;
    }
    .bottom-nav button.active{
      background: rgba(10,186,181,.14);
      color:#0f766e;
      box-shadow: inset 0 0 0 1px rgba(10,186,181,.25);
    }

    /* ===== CARDS / SECTIONS ===== */
    .cardx{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardx-hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .cardx-hd h3, .cardx-hd h4, .cardx-hd h5{margin:0;}
    .cardx-bd{padding: 14px;}
    .muted{color:var(--muted);}
    .mini{font-size:12px;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .chip-ok{border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); color:#047857;}
    .chip-no{border-color: rgba(107,114,128,.25); background: rgba(107,114,128,.10); color:#374151;}

    /* ===== PORTAFOGLIO (mobile list) ===== */
    .filters-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .filters-grid .full{grid-column: 1 / -1;}
    .form-control, .custom-select{border-radius: 12px;}
    .btn{border-radius: 12px; font-weight:800;}
    .btn-primary{background: #0ea5a4; border-color:#0ea5a4;}
    .btn-primary:hover{background:#0b9a98; border-color:#0b9a98;}
    .btn-success{background:#16a34a; border-color:#16a34a;}
    .btn-success:hover{background:#15803d; border-color:#15803d;}

    .shop-list{display:flex; flex-direction:column; gap:10px;}
    .shop-item{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .shop-top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .shop-name{
      font-weight:900;
      font-size:15px;
      line-height:1.15;
      margin:0;
    }
    .shop-meta{
      margin-top:8px;
      font-size:13px;
      color:#334155;
      display:grid;
      grid-template-columns: 1fr;
      gap:4px;
    }
    .shop-meta .k{color:var(--muted); font-weight:800; font-size:12px; margin-right:6px;}
    .shop-actions{
      display:flex; gap:8px; margin-top:10px;
      flex-wrap:wrap;
    }
    .shop-actions .btn{padding:8px 10px; font-size:12px; border-radius: 12px;}
    .btn-danger{background:#ef4444; border-color:#ef4444;}
    .btn-danger:hover{background:#dc2626; border-color:#dc2626;}
    .btn-secondary{background:#64748b; border-color:#64748b;}
    .btn-secondary:hover{background:#475569; border-color:#475569;}

    /* Desktop table fallback */
    .table-wrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    #clientTable{
      min-width: 860px;
      margin:0;
    }
    #clientTable thead th{white-space:nowrap;}

    /* ===== PIANIFICAZIONE ===== */
    .segmented{
      display:flex;
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .segmented button{
      flex:1;
      border:0;
      background:transparent;
      padding:10px 10px;
      font-weight:900;
    }
    .segmented button.active{
      background: rgba(10,186,181,.14);
      color:#0f766e;
      box-shadow: inset 0 0 0 1px rgba(10,186,181,.22);
    }

    /* tabs inside planning */
    .subtabs{
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:4px;
      scrollbar-width: none;
    }
    .subtabs::-webkit-scrollbar{display:none;}
    .subtabs .tabbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight:900;
      white-space:nowrap;
      font-size:13px;
    }
    .subtabs .tabbtn.active{
      border-color: rgba(10,186,181,.35);
      background: rgba(10,186,181,.14);
      color:#0f766e;
    }

    /* ===== MONTH GRID (equal cells + internal scroll) ===== */
    .month-wrap{
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 12px 26px rgba(15,23,42,.06);

      /* vincolo display: il mese NON cresce oltre lo schermo */
      height: calc(100dvh - var(--bottomH) - 260px - env(safe-area-inset-bottom));
      min-height: 420px;
      max-height: 760px;

      display:flex;
      flex-direction:column;
    }

    .month-head{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom:1px solid var(--border);
      background: #f8fafc;
      flex: 0 0 auto;
    }
    .month-head div{
      padding:10px 6px;
      font-weight:900;
      font-size:12px;
      text-align:center;
      color:#334155;
      border-right:1px solid var(--border);
    }
    .month-head div:last-child{border-right:0;}

    .month-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);

      /* scroll SOLO qui (dentro la card) */
      flex: 1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Celle sempre uguali */
    .day-cell{
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:8px 8px 6px;
      position:relative;
      background:#fff;
      overflow:hidden;

      height: clamp(92px, 12.5dvh, 140px);
      min-height: unset;
    }
    .day-cell:nth-child(7n){border-right:0;}
    .day-cell.is-empty{ background:#f8fafc; }

    .day-number{
      position:absolute;
      top:6px; right:8px;
      font-weight:1000;
      font-size:12px;
      color:#64748b;
    }
    .day-cell.today{
      background: rgba(10,186,181,.10);
      box-shadow: inset 0 0 0 2px rgba(10,186,181,.25);
    }

    .day-appointments{
      margin-top:16px;
      height: calc(100% - 18px);
      overflow:auto;
      padding-right:2px;
      -webkit-overflow-scrolling: touch;
    }

    .droppable{border:0!important; padding:0!important;}
    .droppable.over{outline:2px dashed rgba(14,165,164,.55); outline-offset:2px; border-radius: 10px;}

    .appointment-item{
      background:#fff;
      border:1px solid #cbd5e1;
      border-radius: 12px;
      padding: 6px 8px;
      margin-bottom:6px;
      font-size:12px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      position:relative;
      cursor:move;
      user-select:none;
    }
    .appointment-coded{
      background: linear-gradient(90deg, rgba(10,186,181,.92), rgba(7,143,138,.92));
      color:#fff;
      border-color: rgba(255,255,255,.22);
    }
    .delete-btn{
      float:right;
      cursor:pointer;
      color:#ef4444;
      font-weight:1000;
      margin-left:8px;
    }
    .appointment-coded .delete-btn{color: rgba(255,255,255,.92);}

    /* ===== WEEK VIEW ===== */
    .week-controls{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .week-controls .btn{font-size:12px; padding:10px 10px;}
    .week-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .week-day{
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      box-shadow: 0 12px 26px rgba(15,23,42,.06);
      overflow:hidden;
    }
    .week-day-hd{
      padding: 10px 12px;
      background:#f8fafc;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      font-weight:1000;
    }
    .week-day-hd .small{font-size:12px; color:#475569; font-weight:900;}
    .week-day-bd{ padding:10px 12px; }
    .week-drop{
      min-height: 84px;
      max-height: 160px;
      overflow:auto;
      padding-right:2px;
    }
    .week-day.today .week-day-hd{
      background: rgba(10,186,181,.14);
      color:#0f766e;
    }

    /* ===== Modal thumbs ===== */
    .thumbs-hd{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:6px;}
    .thumbs-hd div{font-weight:900; font-size:11px; color:#64748b; text-align:center;}
    .thumbs-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px;}
    .thumbs-grid button{
      width:100%;
      padding:10px 0;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
    }
    .thumbs-grid button.active{
      background: rgba(10,186,181,.14);
      border-color: rgba(10,186,181,.35);
      color:#0f766e;
    }

    /* Mini controls in header */
    .mini-controls{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .mini-controls .custom-select{height:36px; font-weight:900; font-size:13px;}
    .mini-controls .btn{height:36px; padding:0 12px; font-size:12px;}

    /* Responsive tweaks */
    @media (min-width: 992px){
      :root{ --appbarH: 92px; }
      body{overflow:auto;}
      .app-main{padding-bottom: 24px;}
      .bottom-nav{display:none;}
      .week-grid{grid-template-columns: repeat(2, 1fr);}
      .month-head div{font-size:13px;}
      .appointment-item{font-size:12.5px;}
      .month-wrap{
        height: auto;
        max-height: none;
        min-height: 520px;
      }
      .month-grid{ overflow: visible; }
    }
  </style>
</head>

<body>
<div class="app-shell">

  <!-- APPBAR -->
  <header class="appbar">
    <div class="appbar-compact">
      <div class="brand">
        <div class="brand-title">WEBAPP PIANIFICAZIONE</div>
        <div class="brand-sub">Area Manager: <span id="amLabel"></span></div>
      </div>

      <div class="appbar-actions">
        <select id="managerSelect" class="custom-select am-select"></select>

        <button type="button" class="btn-gear" id="openSettingsBtn" aria-label="Impostazioni">
          ⚙️
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="app-main">

    <!-- VIEW CONTAINER -->
    <div class="cardx mb-3">
      <div class="cardx-hd">
        <div class="d-flex align-items-center gap-2" style="gap:10px;">
          <h4 class="mb-0" style="font-weight:1000;">Dashboard</h4>
          <span class="chip" id="yearChip">2025</span>
        </div>

        <div class="d-flex align-items-center" style="gap:10px;">
          <button class="btn btn-sm btn-outline-secondary" id="btnGoTodayTop">OGGI</button>
          <button class="btn btn-sm btn-success" id="sendScheduleBtnTop">INVIA</button>
        </div>
      </div>

      <div class="cardx-bd">
        <!-- Top segmented nav (desktop fallback; on mobile usiamo bottom-nav ma resta anche qui) -->
        <div class="segmented mb-3" id="topSegment">
          <button type="button" id="segPortafoglio" class="active">Portafoglio</button>
          <button type="button" id="segPianificazione">Pianificazione</button>
        </div>

        <!-- CONTENT: Portafoglio -->
        <section id="viewPortafoglio">
          <div class="cardx">
            <div class="cardx-hd">
              <div>
                <h5 style="font-weight:1000;">Portafoglio Negozi</h5>
                <div class="mini muted">
                  Import Excel sovrascrive solo il portafoglio dell’AM selezionato (pianificazione invariata).
                </div>
              </div>
              <div class="d-flex" style="gap:8px; align-items:center;">
                <span class="chip" id="shopsCountChip">0 negozi</span>
              </div>
            </div>

            <div class="cardx-bd">
              <!-- Import Excel -->
              <div class="mb-3">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <strong>Importa Excel</strong>
                  <span class="mini muted">.xls/.xlsx</span>
                </div>
                <input type="file" id="importFile" accept=".xls,.xlsx" class="form-control-file">
              </div>

              <!-- Add shop -->
              <div class="cardx mb-3" style="box-shadow:none;">
                <div class="cardx-bd">
                  <h6 style="font-weight:1000;">Aggiungi negozio</h6>

                  <div class="form-group mb-2">
                    <label class="mini muted mb-1">Nome negozio</label>
                    <input type="text" id="newClientName" class="form-control" placeholder="Nome negozio">
                  </div>

                  <div class="form-group mb-2">
                    <label class="mini muted mb-1">Indirizzo</label>
                    <input type="text" id="newClientIndirizzo" class="form-control" placeholder="Indirizzo">
                  </div>

                  <div class="form-row">
                    <div class="col-6">
                      <label class="mini muted mb-1">Comune</label>
                      <input type="text" id="newClientComune" class="form-control" placeholder="Comune">
                    </div>
                    <div class="col-6">
                      <label class="mini muted mb-1">Città</label>
                      <input type="text" id="newClientCitta" class="form-control" placeholder="Città">
                    </div>
                  </div>

                  <div class="d-flex align-items-center justify-content-between mt-3" style="gap:10px;">
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="newClientCoded">
                      <label class="custom-control-label" for="newClientCoded" style="font-weight:900;">Codificato</label>
                    </div>

                    <button class="btn btn-primary" id="btnAddClient" style="min-width:140px;">Aggiungi</button>
                  </div>
                </div>
              </div>

              <!-- Filters -->
              <div class="cardx mb-3" style="box-shadow:none;">
                <div class="cardx-bd">
                  <h6 style="font-weight:1000;">Filtri</h6>
                  <div class="filters-grid">
                    <div class="full">
                      <input type="text" id="filterName" class="form-control" placeholder="Filtra per nome">
                    </div>
                    <div class="full">
                      <input type="text" id="filterIndirizzo" class="form-control" placeholder="Filtra per indirizzo">
                    </div>
                    <div>
                      <input type="text" id="filterComune" class="form-control" placeholder="Filtra per comune">
                    </div>
                    <div>
                      <input type="text" id="filterCitta" class="form-control" placeholder="Filtra per città">
                    </div>
                    <div class="full">
                      <select id="filterCoded" class="custom-select">
                        <option value="">Tutti</option>
                        <option value="true">Codificati</option>
                        <option value="false">Non codificati</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Mobile list -->
              <div class="d-block d-lg-none">
                <div class="mini muted mb-2">Trascina un negozio sul calendario (vista mensile/settimanale) per pianificare.</div>
                <div id="shopList" class="shop-list"></div>
              </div>

              <!-- Desktop table -->
              <div class="d-none d-lg-block">
                <div class="table-wrap">
                  <table class="table table-bordered" id="clientTable">
                    <thead class="thead-light">
                      <tr>
                        <th>Nome negozio</th>
                        <th>Indirizzo</th>
                        <th>Comune</th>
                        <th>Città</th>
                        <th>Codificato</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- CONTENT: Pianificazione -->
        <section id="viewPianificazione" style="display:none;">
          <div class="cardx">
            <div class="cardx-hd">
              <div>
                <h5 style="font-weight:1000;">Pianificazione</h5>
                <div class="mini muted">Drag & drop dal portafoglio al calendario (max 8 appuntamenti/giorno).</div>
              </div>

              <!-- ✅ Picker anno+mese + OGGI che porta al giorno corrente -->
              <div class="mini-controls">
                <select id="yearSelect" class="custom-select" style="width:auto;">
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                </select>

                <select id="monthSelect" class="custom-select" style="width:auto;">
                  <!-- popolato via JS -->
                </select>

                <button class="btn btn-outline-secondary btn-sm" id="btnGoToday">OGGI</button>
                <button class="btn btn-success btn-sm" id="sendScheduleBtn">INVIA</button>
              </div>
            </div>

            <div class="cardx-bd">
              <!-- Sub tabs (Generale / Settimana / Mese) -->
              <div class="subtabs mb-3" id="planningTabs"></div>

              <!-- PANELS -->
              <div id="panelGenerale" class="planning-panel">
                <div class="d-flex align-items-center justify-content-between mb-2" style="gap:10px; flex-wrap:wrap;">
                  <h6 class="mb-0" style="font-weight:1000;">Classifica Negozi</h6>
                  <div class="d-flex align-items-center" style="gap:8px;">
                    <span class="mini muted" style="font-weight:900;">Filtro:</span>
                    <select id="rankingYearFilter" class="custom-select" style="width:auto;">
                      <option value="ALL">Tutti</option>
                      <option value="2025">Solo 2025</option>
                      <option value="2026">Solo 2026</option>
                    </select>
                  </div>
                </div>
                <div id="generalSummary"></div>
              </div>

              <div id="panelSettimana" class="planning-panel" style="display:none;">
                <div class="week-controls mb-2">
                  <div class="d-flex" style="gap:8px;">
                    <button class="btn btn-outline-secondary" id="prevWeekBtn">◀︎</button>
                    <button class="btn btn-outline-secondary" id="nextWeekBtn">▶︎</button>
                    <button class="btn btn-outline-secondary" id="todayWeekBtn">OGGI</button>
                  </div>
                  <div class="chip" id="weekLabel">Settimana</div>
                </div>
                <div id="weekGrid" class="week-grid"></div>
              </div>

              <div id="panelMese" class="planning-panel" style="display:none;">
                <div class="month-wrap">
                  <div class="month-head" id="monthHead"></div>
                  <div class="month-grid" id="monthGrid"></div>
                </div>
                <div class="mini muted mt-2">Suggerimento: tap su un appuntamento per spostarlo (mese successivo, ecc.).</div>
              </div>

            </div>
          </div>
        </section>

      </div>
    </div>

  </main>

  <!-- BOTTOM NAV (mobile) -->
  <nav class="bottom-nav d-lg-none">
    <div class="nav-pill">
      <button id="navPortafoglio" class="active" type="button">Portafoglio</button>
      <button id="navPianificazione" type="button">Pianificazione</button>
    </div>
  </nav>

</div>

<!-- MODAL: Pianifica -->
<div class="modal fade" id="scheduleModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document"><div class="modal-content">
    <form id="scheduleForm">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:1000;">Pianifica Visita</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label class="mini muted mb-1">Negozio</label>
          <input type="text" id="selectedClientName" class="form-control" readonly>
        </div>

        <div class="form-row">
          <div class="col-6">
            <label class="mini muted mb-1">Anno</label>
            <select id="scheduleYear" class="form-control" required>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div class="col-6">
            <label class="mini muted mb-1">Mese</label>
            <select id="scheduleMonth" class="form-control" required></select>
          </div>
        </div>

        <div class="mt-3">
          <label class="mini muted mb-1">Seleziona giorno</label>
          <div id="dayThumbnails"></div>
          <input type="hidden" id="scheduleDay" required>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Annulla</button>
        <button class="btn btn-primary">Conferma</button>
      </div>
    </form>
  </div></div>
</div>

<!-- MODAL: Sposta appuntamento -->
<div class="modal fade" id="moveModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document"><div class="modal-content">
    <form id="moveForm">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:1000;">Sposta appuntamento</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label class="mini muted mb-1">Negozio</label>
          <input type="text" id="moveClientName" class="form-control" readonly>
        </div>

        <div class="form-row">
          <div class="col-6">
            <label class="mini muted mb-1">Anno</label>
            <select id="moveYear" class="form-control" required>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div class="col-6">
            <label class="mini muted mb-1">Mese</label>
            <select id="moveMonth" class="form-control" required></select>
          </div>
        </div>

        <div class="mt-3">
          <label class="mini muted mb-1">Seleziona giorno</label>
          <div id="moveDayThumbnails"></div>
          <input type="hidden" id="moveDay" required>
          <div class="mini muted mt-2">Puoi spostarlo anche su un mese non visibile ora: viene salvato comunque.</div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Annulla</button>
        <button class="btn btn-primary">Sposta</button>
      </div>
    </form>
  </div></div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:1000;">Impostazioni</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        <div class="cardx" style="box-shadow:none;">
          <div class="cardx-bd">
            <div class="mini muted mb-2" style="font-weight:900;">Gestione Area Manager</div>

            <div class="form-group mb-2">
              <label class="mini muted mb-1">Nuovo AM</label>
              <input type="text" id="newManagerName" class="form-control" placeholder="Nuovo AM">
            </div>

            <div class="d-flex" style="gap:10px;">
              <button class="btn btn-outline-secondary flex-fill" onclick="addManager()">Aggiungi</button>
              <button class="btn btn-outline-secondary flex-fill" id="renameManagerBtn">Rinomina</button>
              <button class="btn btn-outline-secondary flex-fill" id="deleteManagerBtn">Elimina</button>
            </div>
          </div>
        </div>

        <div class="cardx mt-3" style="box-shadow:none;">
          <div class="cardx-bd">
            <div class="mini muted mb-2" style="font-weight:900;">Backup</div>
            <div class="d-flex" style="gap:10px;">
              <button class="btn btn-primary flex-fill" id="exportAllBtn">ESPORTA JSON</button>

              <label class="btn btn-outline-secondary flex-fill mb-0" style="display:flex;align-items:center;justify-content:center;cursor:pointer;">
                IMPORTA
                <input type="file" id="importAllFile" accept=".json" hidden>
              </label>
            </div>

            <div class="mini muted mt-2">
              Backup completo (AM + Portafogli + Pianificazioni).
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- jQuery, Popper, Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
  let currentManager = '';
  let currentClientId = null;

  const weekdays = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];

  const MONTHS_BY_YEAR = {
    2025: [
      { label: "Aprile",    monthIndex0: 3,  monthNumber: 4,  key: "aprile" },
      { label: "Maggio",    monthIndex0: 4,  monthNumber: 5,  key: "maggio" },
      { label: "Giugno",    monthIndex0: 5,  monthNumber: 6,  key: "giugno" },
      { label: "Luglio",    monthIndex0: 6,  monthNumber: 7,  key: "luglio" },
      { label: "Agosto",    monthIndex0: 7,  monthNumber: 8,  key: "agosto" },
      { label: "Settembre", monthIndex0: 8,  monthNumber: 9,  key: "settembre" },
      { label: "Ottobre",   monthIndex0: 9,  monthNumber: 10, key: "ottobre" },
      { label: "Novembre",  monthIndex0: 10, monthNumber: 11, key: "novembre" },
      { label: "Dicembre",  monthIndex0: 11, monthNumber: 12, key: "dicembre" }
    ],
    2026: [
      { label: "Gennaio",   monthIndex0: 0,  monthNumber: 1,  key: "gennaio" },
      { label: "Febbraio",  monthIndex0: 1,  monthNumber: 2,  key: "febbraio" },
      { label: "Marzo",     monthIndex0: 2,  monthNumber: 3,  key: "marzo" },
      { label: "Aprile",    monthIndex0: 3,  monthNumber: 4,  key: "aprile" },
      { label: "Maggio",    monthIndex0: 4,  monthNumber: 5,  key: "maggio" },
      { label: "Giugno",    monthIndex0: 5,  monthNumber: 6,  key: "giugno" },
      { label: "Luglio",    monthIndex0: 6,  monthNumber: 7,  key: "luglio" },
      { label: "Agosto",    monthIndex0: 7,  monthNumber: 8,  key: "agosto" },
      { label: "Settembre", monthIndex0: 8,  monthNumber: 9,  key: "settembre" },
      { label: "Ottobre",   monthIndex0: 9,  monthNumber: 10, key: "ottobre" },
      { label: "Novembre",  monthIndex0: 10, monthNumber: 11, key: "novembre" },
      { label: "Dicembre",  monthIndex0: 11, monthNumber: 12, key: "dicembre" }
    ]
  };

  let selectedYear = 2025;

  // Week view state
  let weekStartDate = null; // Monday

  // Move modal state
  let moving = { name:"", coded:false, fromDate:"" };

  // ========= UTILS DATE =========
  function getTodayLocal(){ return new Date(); }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function toISODate(d){
    const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate());
    return `${y}-${m}-${day}`;
  }
  function parseISODate(iso){
    const [y,m,d]=iso.split("-").map(Number);
    return new Date(y, m-1, d);
  }
  function startOfWeekMonday(date){
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const day = d.getDay(); // 0 Sun..6 Sat
    const diff = (day===0 ? -6 : 1-day); // move to Monday
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }
  function addDays(date, n){
    const d=new Date(date);
    d.setDate(d.getDate()+n);
    return d;
  }

  function getMonthKeyForYear(year, monthNumber1to12){
    const m=(MONTHS_BY_YEAR[year]||[]).find(x=>x.monthNumber===monthNumber1to12);
    return m?m.key:null;
  }
  function pickBestMonth(year){
    const today=getTodayLocal();
    if(today.getFullYear()===year){
      const k=getMonthKeyForYear(year, today.getMonth()+1);
      return k || (MONTHS_BY_YEAR[year]||[])[0]?.key || null;
    }
    return (MONTHS_BY_YEAR[year]||[])[0]?.key || null;
  }

  function normalizeActiveMonthForYear(year, desiredMonth){
    const list = MONTHS_BY_YEAR[year] || [];
    if(!list.length) return 1;
    const ok = list.some(m => m.monthNumber === desiredMonth);
    if(ok) return desiredMonth;
    // fallback: first available month in that year
    return list[0].monthNumber;
  }

  // ========= STORAGE HELPERS =========
  function getManagersList(){ return JSON.parse(localStorage.getItem("areaManagers")) || []; }
  function setManagersList(list){ localStorage.setItem("areaManagers", JSON.stringify(list)); }
  function clientsKey(mgr){ return "clientsData_" + mgr; }
  function appsKey(mgr){ return "appointmentsData_" + mgr; }

  // ========= AREA MANAGER CRUD =========
  function loadManagers(){
    let list=getManagersList();
    if(!list.length){
      list=["MARIO ISERNIA"];
      setManagersList(list);
    }
    const sel=document.getElementById("managerSelect");
    sel.innerHTML="";
    list.forEach(m=>sel.add(new Option(m,m)));
    currentManager = sel.value;
    renderAmLabel();
  }

  function renderAmLabel(){
    const el=document.getElementById("amLabel");
    el.textContent = currentManager || "-";
  }

  function addManager(){
    const nm=document.getElementById("newManagerName").value.trim();
    if(!nm){ alert("Inserisci un nome."); return; }
    let list=getManagersList();
    if(list.includes(nm)){ alert("Esiste già."); return; }

    list.push(nm);
    setManagersList(list);

    loadManagers();
    document.getElementById("managerSelect").value=nm;
    currentManager=nm;
    renderAmLabel();

    document.getElementById("newManagerName").value="";
    reloadAll();
  }

  function renameManager(){
    const oldName=document.getElementById("managerSelect").value;
    if(!oldName){ alert("Seleziona un Area Manager."); return; }

    const newName=prompt("Nuovo nome Area Manager:", oldName);
    if(newName===null) return;
    const nn=newName.trim();
    if(!nn){ alert("Nome non valido."); return; }

    let list=getManagersList();
    if(nn!==oldName && list.includes(nn)){ alert("Esiste già."); return; }

    const ok=confirm(`Rinominare "${oldName}" in "${nn}"?\n\nVerranno mantenuti portafoglio e pianificazioni.`);
    if(!ok) return;

    const oldClients=localStorage.getItem(clientsKey(oldName));
    const oldApps=localStorage.getItem(appsKey(oldName));

    if(oldClients!==null) localStorage.setItem(clientsKey(nn), oldClients);
    if(oldApps!==null) localStorage.setItem(appsKey(nn), oldApps);

    localStorage.removeItem(clientsKey(oldName));
    localStorage.removeItem(appsKey(oldName));

    list=list.map(m=>(m===oldName?nn:m));
    setManagersList(list);

    if(currentManager===oldName) currentManager=nn;

    loadManagers();
    document.getElementById("managerSelect").value=nn;
    currentManager=nn;
    renderAmLabel();

    reloadAll();
  }

  function deleteManager(){
    const name=document.getElementById("managerSelect").value;
    if(!name){ alert("Seleziona un Area Manager."); return; }

    let list=getManagersList();
    if(list.length<=1){ alert("Non puoi eliminare l'ultimo Area Manager."); return; }

    const ok=confirm(`Eliminare "${name}"?\n\nATTENZIONE: verranno cancellati portafoglio e pianificazioni di questo Area Manager.`);
    if(!ok) return;

    localStorage.removeItem(clientsKey(name));
    localStorage.removeItem(appsKey(name));

    list=list.filter(m=>m!==name);
    setManagersList(list);

    if(currentManager===name) currentManager=list[0];

    loadManagers();
    document.getElementById("managerSelect").value=currentManager;
    renderAmLabel();

    reloadAll();
  }

  document.getElementById("renameManagerBtn").addEventListener("click", renameManager);
  document.getElementById("deleteManagerBtn").addEventListener("click", deleteManager);

  document.getElementById("managerSelect").addEventListener("change", ()=>{
    currentManager = document.getElementById("managerSelect").value;
    renderAmLabel();
    reloadAll();
  });

  // ========= BACKUP export/import =========
  function buildBackupPayload(){
    const payload={
      app:"PIANIFICAZIONE_SETTIMANALE",
      version:"webapp-mobile-v1",
      exportedAt:new Date().toISOString(),
      keys:{}
    };
    const areaManagers=getManagersList();
    payload.keys["areaManagers"]=areaManagers;
    areaManagers.forEach(mgr=>{
      payload.keys[clientsKey(mgr)] = JSON.parse(localStorage.getItem(clientsKey(mgr)) || "null");
      payload.keys[appsKey(mgr)]    = JSON.parse(localStorage.getItem(appsKey(mgr)) || "null");
    });
    payload.keys["_lastManager"]=currentManager||"";
    return payload;
  }

  function downloadJson(filename,obj){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  document.getElementById("exportAllBtn").addEventListener("click", ()=>{
    const payload=buildBackupPayload();
    const stamp=new Date();
    const fn=`backup_webapp_pianificazione_${stamp.getFullYear()}-${pad2(stamp.getMonth()+1)}-${pad2(stamp.getDate())}.json`;
    downloadJson(fn,payload);
  });

  document.getElementById("importAllFile").addEventListener("change",(e)=>{
    const file=e.target.files && e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
      try{
        const obj=JSON.parse(ev.target.result);
        if(!obj || !obj.keys || obj.app!=="PIANIFICAZIONE_SETTIMANALE"){
          alert("File non valido o non compatibile.");
          return;
        }
        const ok=confirm("Importare il backup?\n\nSovrascrive i dati locali (Area Manager, Portafogli, Pianificazioni).");
        if(!ok) return;

        Object.entries(obj.keys).forEach(([k,v])=>{
          if(v===null || typeof v==="undefined") localStorage.removeItem(k);
          else localStorage.setItem(k, JSON.stringify(v));
        });

        loadManagers();
        const last=(obj.keys["_lastManager"]||"");
        if(last){
          document.getElementById("managerSelect").value=last;
          currentManager=last;
        } else {
          currentManager=document.getElementById("managerSelect").value;
        }
        renderAmLabel();

        const today=getTodayLocal();
        const initYear = (today.getFullYear()===2025 || today.getFullYear()===2026) ? today.getFullYear() : 2026;
        selectedYear=initYear;
        document.getElementById("yearSelect").value=String(initYear);

        weekStartDate = startOfWeekMonday(today);

        // month
        activeMonthNumber = normalizeActiveMonthForYear(selectedYear, today.getMonth()+1);
        populateMonthSelect();

        reloadAll();
        alert("Backup importato correttamente.");
      }catch(err){
        console.error(err);
        alert("Errore: il file JSON non è leggibile.");
      }
    };
    reader.readAsText(file);
    e.target.value="";
  });

  // ========= NAV (Portafoglio / Pianificazione) =========
  function showView(which){
    const isPort = which==="port";
    document.getElementById("viewPortafoglio").style.display = isPort ? "" : "none";
    document.getElementById("viewPianificazione").style.display = isPort ? "none" : "";

    // top segment
    document.getElementById("segPortafoglio").classList.toggle("active", isPort);
    document.getElementById("segPianificazione").classList.toggle("active", !isPort);

    // bottom nav
    document.getElementById("navPortafoglio").classList.toggle("active", isPort);
    document.getElementById("navPianificazione").classList.toggle("active", !isPort);

    if(!isPort){
      populateMonthSelect();
      rebuildPlanningTabs();
      renderActivePlanningPanel();
      loadAppointmentsToViews();
      updateGeneralSummary();
    }
  }

  document.getElementById("segPortafoglio").addEventListener("click", ()=>showView("port"));
  document.getElementById("segPianificazione").addEventListener("click", ()=>showView("plan"));
  document.getElementById("navPortafoglio").addEventListener("click", ()=>showView("port"));
  document.getElementById("navPianificazione").addEventListener("click", ()=>showView("plan"));

  // ========= YEAR SELECT =========
  document.getElementById("yearSelect").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("yearSelect").value,10);
    if(!y || !MONTHS_BY_YEAR[y]) return;
    selectedYear=y;

    // mese coerente con anno
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, activeMonthNumber || (getTodayLocal().getMonth()+1));
    populateMonthSelect();

    syncYearChip();
    rebuildPlanningTabs();
    renderActivePlanningPanel();
    loadAppointmentsToViews();
    updateGeneralSummary();
  });

  // ========= MONTH DROPDOWN PICKER =========
  function populateMonthSelect(){
    const sel = document.getElementById("monthSelect");
    const list = MONTHS_BY_YEAR[selectedYear] || [];
    sel.innerHTML = "";
    list.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = String(m.monthNumber);
      opt.textContent = m.label;
      sel.appendChild(opt);
    });

    // ensure activeMonthNumber valid
    if(!activeMonthNumber){
      const bestKey=pickBestMonth(selectedYear);
      const bestMonth = bestKey
        ? (MONTHS_BY_YEAR[selectedYear].find(m=>m.key===bestKey)?.monthNumber || list[0]?.monthNumber)
        : list[0]?.monthNumber;
      activeMonthNumber = bestMonth || list[0]?.monthNumber || 1;
    }
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, activeMonthNumber);

    sel.value = String(activeMonthNumber);
  }

  document.getElementById("monthSelect").addEventListener("change", ()=>{
    const mv = parseInt(document.getElementById("monthSelect").value, 10);
    if(!mv) return;
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, mv);

    // porta alla vista mese senza rifare UI
    activatePlanningTab("mese");
    renderActivePlanningPanel();
    loadAppointmentsToViews();
    updateGeneralSummary();
    setTimeout(scrollTodayIntoView, 60);
  });

  function syncYearChip(){
    document.getElementById("yearChip").textContent = String(selectedYear);
    document.getElementById("yearSelect").value = String(selectedYear);
  }

  // ========= TODAY buttons =========
  function scrollTodayIntoView(){
    if(activePlanningTab!=="mese") return;
    const t = getTodayLocal();
    if(t.getFullYear() !== selectedYear) return;
    if((t.getMonth()+1) !== activeMonthNumber) return;

    const el = document.querySelector('.day-cell.today');
    if(!el) return;
    el.scrollIntoView({ block: "center", inline: "nearest", behavior: "smooth" });
  }

  function goToday(){
    const t=getTodayLocal();
    const y=t.getFullYear();

    // anno ammesso
    selectedYear = (y===2025 || y===2026) ? y : 2026;
    syncYearChip();

    // mese ammesso per anno selezionato
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, t.getMonth()+1);
    populateMonthSelect();

    rebuildPlanningTabs();
    activatePlanningTab("mese");
    renderActivePlanningPanel();
    loadAppointmentsToViews();
    updateGeneralSummary();
    setTimeout(scrollTodayIntoView, 80);
  }

  document.getElementById("btnGoToday").addEventListener("click", goToday);
  document.getElementById("btnGoTodayTop").addEventListener("click", ()=>{
    showView("plan");
    goToday();
  });

  // ========= IMPORT EXCEL =========
  document.getElementById("importFile").addEventListener("change", e=>{
    const f=e.target.files[0];
    if(!f) return;

    const r=new FileReader();
    r.onload=ev=>{
      const data=new Uint8Array(ev.target.result);
      const wb=XLSX.read(data,{type:"array"});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});

      localStorage.removeItem(clientsKey(currentManager));

      const arr=[];
      rows.forEach(rw=>{
        const name=String(rw["Nome negozio"]||"").trim();
        const indirizzo=String(rw["Indirizzo"]||"").trim();
        const comune=String(rw["Comune"]||"").trim();
        const citta=String(rw["Città"]||"").trim();
        const cv=String(rw["Codificato"]||"").trim().toUpperCase();
        const coded=(cv==="SI");

        if(!name && !indirizzo && !comune && !citta) return;
        arr.push({
          id:"client-"+Date.now()+"-"+Math.random(),
          name, indirizzo, comune, citta, coded
        });
      });

      arr.sort((a,b)=>a.name.localeCompare(b.name));
      localStorage.setItem(clientsKey(currentManager), JSON.stringify(arr));

      loadClients();
      updateGeneralSummary();
    };
    r.readAsArrayBuffer(f);
    e.target.value="";
  });

  // ========= FILTERS =========
  ["Name","Indirizzo","Comune","Citta"].forEach(k=>{
    document.getElementById("filter"+k).addEventListener("input", filterClientsAndRender);
  });
  document.getElementById("filterCoded").addEventListener("change", filterClientsAndRender);

  function getFilterState(){
    return {
      name: document.getElementById("filterName").value.toLowerCase(),
      indirizzo: document.getElementById("filterIndirizzo").value.toLowerCase(),
      comune: document.getElementById("filterComune").value.toLowerCase(),
      citta: document.getElementById("filterCitta").value.toLowerCase(),
      coded: document.getElementById("filterCoded").value
    };
  }

  function clientPassesFilter(c, f){
    let show=true;
    if(f.name && !String(c.name).toLowerCase().includes(f.name)) show=false;
    if(f.indirizzo && !String(c.indirizzo).toLowerCase().includes(f.indirizzo)) show=false;
    if(f.comune && !String(c.comune).toLowerCase().includes(f.comune)) show=false;
    if(f.citta && !String(c.citta).toLowerCase().includes(f.citta)) show=false;
    if(f.coded){
      const cd = c.coded ? "true" : "false";
      if(cd!==f.coded) show=false;
    }
    return show;
  }

  // ========= DRAG & DROP =========
  function dragStart(e){
    const t=e.currentTarget;
    if(t.classList.contains("appointment-item")){
      e.dataTransfer.setData("type","appointment");
      e.dataTransfer.setData("appointmentId", t.dataset.appId || t.id);
      e.dataTransfer.setData("fromDate", t.dataset.fromDate || "");
    } else {
      e.dataTransfer.setData("type","client");
      e.dataTransfer.setData("clientId", t.dataset.clientId);
    }
  }
  function allowDrop(e){
    e.preventDefault();
    e.currentTarget.classList.add("over");
  }
  function dragLeave(e){
    e.currentTarget.classList.remove("over");
  }

  function dropToDate(dateISO, targetContainer){
    if(!dateISO) return;

    // limit 8
    const currentCount = targetContainer.querySelectorAll(".appointment-item").length;
    if(currentCount>=8){ alert("Limite di 8 appuntamenti."); return; }

    const type = window._dndType;
    if(type==="client"){
      const id = window._dndClientId;
      const client = getClientById(id);
      if(!client) return;
      upsertAppointmentToStorage(dateISO, {name: client.name, coded: !!client.coded});
    } else if(type==="appointment"){
      const appId = window._dndAppId;
      const fromDate = window._dndFromDate;
      const appEl = document.querySelector(`[data-app-id="${cssEscape(appId)}"]`) || document.getElementById(appId);

      if(appEl){
        const name = appEl.dataset.name;
        const coded = (appEl.dataset.coded==="true");
        if(fromDate) removeAppointmentFromStorage(fromDate, name, coded);
        upsertAppointmentToStorage(dateISO, {name, coded});
      }
    }

    loadAppointmentsToViews();
    updateGeneralSummary();
  }

  function handleDrop(e){
    e.preventDefault();
    e.currentTarget.classList.remove("over");

    const dateISO = e.currentTarget.dataset.date;
    if(!dateISO) return;

    const targetContainer = e.currentTarget.querySelector(".day-appointments") || e.currentTarget;
    dropToDate(dateISO, targetContainer);
  }

  // ========= APPOINTMENT ELEMENT =========
  function createAppointmentEl(name, isCoded, fromDate){
    const div=document.createElement("div");
    const id="appointment-"+Date.now()+"-"+Math.random();

    div.id=id;
    div.dataset.appId = id;
    div.dataset.name=name;
    div.dataset.coded=isCoded ? "true" : "false";
    div.dataset.fromDate = fromDate || "";

    div.className="appointment-item" + (isCoded ? " appointment-coded" : "");
    div.draggable=true;
    div.addEventListener("dragstart", (e)=>{
      window._dndType="appointment";
      window._dndAppId=div.dataset.appId;
      window._dndFromDate=div.dataset.fromDate;
      dragStart(e);
    });

    // tap-to-move
    div.addEventListener("click", (ev)=>{
      if(ev.target && ev.target.classList.contains("delete-btn")) return;
      openMoveModal(div.dataset.name, (div.dataset.coded==="true"), div.dataset.fromDate);
    });

    const span=document.createElement("span");
    span.textContent=name;
    div.appendChild(span);

    const del=document.createElement("span");
    del.className="delete-btn";
    del.innerHTML="&times;";
    del.onclick=(e)=>{
      e.stopPropagation();
      removeAppointmentFromStorage(div.dataset.fromDate, div.dataset.name, (div.dataset.coded==="true"));
      loadAppointmentsToViews();
      updateGeneralSummary();
    };
    div.appendChild(del);

    return div;
  }

  // ========= PORTAFOGLIO =========
  function getClients(){
    return JSON.parse(localStorage.getItem(clientsKey(currentManager)))||[];
  }

  function setClients(arr){
    localStorage.setItem(clientsKey(currentManager), JSON.stringify(arr));
  }

  function getClientById(id){
    return getClients().find(c=>c.id===id);
  }

  document.getElementById("btnAddClient").addEventListener("click", ()=>{
    const n=document.getElementById("newClientName").value.trim();
    const i=document.getElementById("newClientIndirizzo").value.trim();
    const c=document.getElementById("newClientComune").value.trim();
    const ct=document.getElementById("newClientCitta").value.trim();
    const cd=document.getElementById("newClientCoded").checked;

    if(!n || !i || !c || !ct){
      alert("Compila tutti i campi.");
      return;
    }

    const arr=getClients();
    arr.push({ id:"client-"+Date.now()+"-"+Math.random(), name:n, indirizzo:i, comune:c, citta:ct, coded:cd });
    arr.sort((a,b)=>a.name.localeCompare(b.name));
    setClients(arr);

    ["newClientName","newClientIndirizzo","newClientComune","newClientCitta"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("newClientCoded").checked=false;

    loadClients();
    updateGeneralSummary();
  });

  // Desktop table row
  function addClientRowDesktop(client){
    const tbody=document.querySelector("#clientTable tbody");
    const tr=document.createElement("tr");
    tr.id=client.id;
    tr.dataset.clientId=client.id;
    tr.draggable=true;
    tr.addEventListener("dragstart", (e)=>{
      window._dndType="client";
      window._dndClientId=client.id;
      dragStart(e);
    });

    const tdName=document.createElement("td"); tdName.textContent=client.name; tr.appendChild(tdName);
    const tdInd=document.createElement("td"); tdInd.textContent=client.indirizzo; tr.appendChild(tdInd);
    const tdCom=document.createElement("td"); tdCom.textContent=client.comune; tr.appendChild(tdCom);
    const tdCit=document.createElement("td"); tdCit.textContent=client.citta; tr.appendChild(tdCit);

    const tdCoded=document.createElement("td");
    tdCoded.className="text-center";
    const chk=document.createElement("input");
    chk.type="checkbox"; chk.checked=!!client.coded;
    chk.onchange=()=>{
      const arr=getClients().map(x=>x.id===client.id ? {...x, coded:chk.checked} : x);
      setClients(arr);
      loadClients();
      updateGeneralSummary();
    };
    tdCoded.appendChild(chk);
    tr.appendChild(tdCoded);

    const tdAct=document.createElement("td");
    const btnEdit=document.createElement("button");
    btnEdit.className="btn btn-sm btn-secondary mr-1";
    btnEdit.textContent="Modifica";
    btnEdit.onclick=()=>editClient(client.id);
    const btnPlan=document.createElement("button");
    btnPlan.className="btn btn-sm btn-primary mr-1";
    btnPlan.textContent="Pianifica";
    btnPlan.onclick=()=>openScheduleModal(client.id);
    const btnDel=document.createElement("button");
    btnDel.className="btn btn-sm btn-danger";
    btnDel.textContent="Cancella";
    btnDel.onclick=()=>deleteClient(client.id);

    tdAct.appendChild(btnEdit);
    tdAct.appendChild(btnPlan);
    tdAct.appendChild(btnDel);
    tr.appendChild(tdAct);

    tbody.appendChild(tr);
  }

  // Mobile card
  function addClientCardMobile(client){
    const wrap=document.getElementById("shopList");
    const el=document.createElement("div");
    el.className="shop-item";
    el.dataset.clientId=client.id;
    el.draggable=true;

    el.addEventListener("dragstart", (e)=>{
      window._dndType="client";
      window._dndClientId=client.id;
      dragStart(e);
    });

    const codedChip = client.coded
      ? `<span class="chip chip-ok">Codificato</span>`
      : `<span class="chip chip-no">Non codificato</span>`;

    el.innerHTML = `
      <div class="shop-top">
        <div style="min-width:0;">
          <p class="shop-name">${escapeHtml(client.name)}</p>
          <div class="mini muted" style="margin-top:6px;">Trascina per pianificare</div>
        </div>
        <div>${codedChip}</div>
      </div>

      <div class="shop-meta">
        <div><span class="k">Ind:</span>${escapeHtml(client.indirizzo)}</div>
        <div><span class="k">Comune:</span>${escapeHtml(client.comune)} <span class="k" style="margin-left:10px;">Città:</span>${escapeHtml(client.citta)}</div>
      </div>

      <div class="shop-actions">
        <button class="btn btn-secondary btn-sm" data-act="edit">Modifica</button>
        <button class="btn btn-primary btn-sm" data-act="plan">Pianifica</button>
        <button class="btn btn-outline-secondary btn-sm" data-act="toggle">${client.coded ? "Segna NON cod." : "Segna cod."}</button>
        <button class="btn btn-danger btn-sm" data-act="del">Cancella</button>
      </div>
    `;

    el.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        const act=b.dataset.act;
        if(act==="edit") editClient(client.id);
        if(act==="plan") openScheduleModal(client.id);
        if(act==="toggle"){
          const arr=getClients().map(x=>x.id===client.id ? {...x, coded:!x.coded} : x);
          setClients(arr);
          loadClients();
          updateGeneralSummary();
        }
        if(act==="del") deleteClient(client.id);
      });
    });

    wrap.appendChild(el);
  }

  function loadClients(){
    let arr=getClients();

    if(!arr.length){
      arr=[
        {id:"client-1",name:"Negozio A",indirizzo:"Via Roma 1",comune:"Centro",citta:"Milano",coded:false},
        {id:"client-2",name:"Negozio B",indirizzo:"Viale Europa 10",comune:"Periferia",citta:"Roma",coded:false}
      ];
      setClients(arr);
    }

    arr.sort((a,b)=>a.name.localeCompare(b.name));

    document.getElementById("shopsCountChip").textContent = `${arr.length} negozi`;

    const tbody=document.querySelector("#clientTable tbody");
    if(tbody) tbody.innerHTML="";
    arr.forEach(addClientRowDesktop);

    const list=document.getElementById("shopList");
    if(list) list.innerHTML="";
    const f=getFilterState();
    arr.filter(c=>clientPassesFilter(c,f)).forEach(addClientCardMobile);

    filterClientsDesktop(arr, f);
  }

  function filterClientsDesktop(arr, f){
    document.querySelectorAll("#clientTable tbody tr").forEach(tr=>{
      const id=tr.dataset.clientId;
      const c=arr.find(x=>x.id===id);
      if(!c){ tr.style.display="none"; return; }
      tr.style.display = clientPassesFilter(c,f) ? "" : "none";
    });
  }

  function filterClientsAndRender(){
    loadClients();
  }

  function editClient(id){
    const arr=getClients();
    const c=arr.find(x=>x.id===id);
    if(!c) return;
    const nn=prompt("Modifica nome:", c.name);
    if(nn){
      c.name=nn.trim();
      setClients(arr);
      loadClients();
      updateGeneralSummary();
    }
  }

  function deleteClient(id){
    if(!confirm("Eliminare il negozio?")) return;
    const arr=getClients().filter(x=>x.id!==id);
    setClients(arr);
    loadClients();
    updateGeneralSummary();
  }

  // ========= APPOINTMENTS STORAGE =========
  function getAppointments(){
    return JSON.parse(localStorage.getItem(appsKey(currentManager)))||{};
  }
  function setAppointments(obj){
    localStorage.setItem(appsKey(currentManager), JSON.stringify(obj));
  }

  function upsertAppointmentToStorage(dateISO, item){
    const data=getAppointments();
    const arr=data[dateISO] ? [...data[dateISO]] : [];
    if(arr.length>=8){
      alert("Limite di 8 appuntamenti.");
      return;
    }
    arr.push({name:item.name, coded:!!item.coded});
    data[dateISO]=arr;
    setAppointments(data);
  }

  function removeAppointmentFromStorage(dateISO, name, coded){
    if(!dateISO) return;
    const data=getAppointments();
    const arr=data[dateISO] || [];
    const idx = arr.findIndex(x=>x.name===name && !!x.coded===!!coded);
    if(idx>=0) arr.splice(idx,1);
    if(arr.length) data[dateISO]=arr;
    else delete data[dateISO];
    setAppointments(data);
  }

  // ========= PLANNING TABS =========
  let activePlanningTab = "generale"; // generale | settimana | mese
  let activeMonthNumber = null; // 1..12 for selectedYear

  function rebuildPlanningTabs(){
    const tabs=document.getElementById("planningTabs");
    tabs.innerHTML="";

    const addTab=(key,label)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="tabbtn" + (activePlanningTab===key ? " active" : "");
      b.textContent=label;
      b.addEventListener("click", ()=>{
        activatePlanningTab(key);
        renderActivePlanningPanel();
        loadAppointmentsToViews();
        if(key==="mese") setTimeout(scrollTodayIntoView, 60);
      });
      tabs.appendChild(b);
    };

    addTab("generale","Generale");
    addTab("settimana","Settimana");

    const list = MONTHS_BY_YEAR[selectedYear] || [];
    if(!activeMonthNumber){
      const bestKey=pickBestMonth(selectedYear);
      const bestMonth = bestKey
        ? (MONTHS_BY_YEAR[selectedYear].find(m=>m.key===bestKey)?.monthNumber || list[0]?.monthNumber)
        : list[0]?.monthNumber;
      activeMonthNumber = bestMonth || list[0]?.monthNumber || 1;
    }
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, activeMonthNumber);

    const monthLabel = (MONTHS_BY_YEAR[selectedYear].find(m=>m.monthNumber===activeMonthNumber)?.label) || "Mese";
    addTab("mese", monthLabel);

    syncYearChip();
  }

  function activatePlanningTab(key){
    activePlanningTab = key;
    rebuildPlanningTabs();
  }

  function renderActivePlanningPanel(){
    document.getElementById("panelGenerale").style.display = (activePlanningTab==="generale") ? "" : "none";
    document.getElementById("panelSettimana").style.display = (activePlanningTab==="settimana") ? "" : "none";
    document.getElementById("panelMese").style.display = (activePlanningTab==="mese") ? "" : "none";

    if(activePlanningTab==="mese"){
      renderMonthView(selectedYear, activeMonthNumber);
      setTimeout(scrollTodayIntoView, 60);
    }
    if(activePlanningTab==="settimana"){
      renderWeekView();
    }
    if(activePlanningTab==="generale"){
      updateGeneralSummary();
    }
  }

  // ========= MONTH VIEW RENDER =========
  function daysInMonth(y,mIndex0){ return new Date(y,mIndex0+1,0).getDate(); }
  function weekdayMon0(y,mIndex0,d){ const w=new Date(y,mIndex0,d).getDay(); return w ? w-1 : 6; } // Mon=0..Sun=6

  function renderMonthView(year, monthNumber){
    const mIndex0 = monthNumber - 1;

    const mh=document.getElementById("monthHead");
    mh.innerHTML="";
    weekdays.forEach(w=>{
      const d=document.createElement("div");
      d.textContent=w;
      mh.appendChild(d);
    });

    const mg=document.getElementById("monthGrid");
    mg.innerHTML="";

    const total=daysInMonth(year, mIndex0);
    const first=weekdayMon0(year, mIndex0, 1);

    const today=getTodayLocal();
    const todayISO = toISODate(today);

    for(let i=0;i<first;i++){
      const empty=document.createElement("div");
      empty.className="day-cell is-empty";
      mg.appendChild(empty);
    }

    for(let day=1; day<=total; day++){
      const cell=document.createElement("div");
      const iso = `${year}-${pad2(monthNumber)}-${pad2(day)}`;
      cell.className="day-cell droppable";
      cell.dataset.date=iso;

      cell.addEventListener("dragover", allowDrop);
      cell.addEventListener("dragleave", dragLeave);
      cell.addEventListener("drop", (e)=>{
        const type=e.dataTransfer.getData("type");
        if(type==="client"){
          window._dndType="client";
          window._dndClientId=e.dataTransfer.getData("clientId");
        } else {
          window._dndType="appointment";
          window._dndAppId=e.dataTransfer.getData("appointmentId");
          window._dndFromDate=e.dataTransfer.getData("fromDate");
        }
        handleDrop(e);
      });

      if(iso===todayISO) cell.classList.add("today");

      const num=document.createElement("div");
      num.className="day-number";
      num.textContent=day;

      const apps=document.createElement("div");
      apps.className="day-appointments";

      cell.appendChild(num);
      cell.appendChild(apps);
      mg.appendChild(cell);
    }

    const cellsSoFar = first + total;
    const remainder = cellsSoFar % 7;
    if(remainder!==0){
      for(let i=0;i<7-remainder;i++){
        const empty=document.createElement("div");
        empty.className="day-cell is-empty";
        mg.appendChild(empty);
      }
    }
  }

  // ========= WEEK VIEW RENDER =========
  function renderWeekView(){
    const grid=document.getElementById("weekGrid");
    grid.innerHTML="";

    const today=getTodayLocal();
    if(!weekStartDate) weekStartDate = startOfWeekMonday(today);

    const label=document.getElementById("weekLabel");
    const end = addDays(weekStartDate, 6);
    label.textContent = `${toISODate(weekStartDate)} → ${toISODate(end)}`;

    const todayISO = toISODate(today);

    for(let i=0;i<7;i++){
      const d=addDays(weekStartDate, i);
      const iso=toISODate(d);
      const wname=weekdays[i];

      const box=document.createElement("div");
      box.className="week-day";
      if(iso===todayISO) box.classList.add("today");

      const hd=document.createElement("div");
      hd.className="week-day-hd";
      hd.innerHTML = `<div>${wname}</div><div class="small">${iso}</div>`;

      const bd=document.createElement("div");
      bd.className="week-day-bd";

      const drop=document.createElement("div");
      drop.className="week-drop droppable";
      drop.dataset.date=iso;

      drop.addEventListener("dragover", allowDrop);
      drop.addEventListener("dragleave", dragLeave);
      drop.addEventListener("drop", (e)=>{
        const type=e.dataTransfer.getData("type");
        if(type==="client"){
          window._dndType="client";
          window._dndClientId=e.dataTransfer.getData("clientId");
        } else {
          window._dndType="appointment";
          window._dndAppId=e.dataTransfer.getData("appointmentId");
          window._dndFromDate=e.dataTransfer.getData("fromDate");
        }
        handleDrop(e);
      });

      bd.appendChild(drop);
      box.appendChild(hd);
      box.appendChild(bd);
      grid.appendChild(box);
    }
  }

  document.getElementById("prevWeekBtn").addEventListener("click", ()=>{
    weekStartDate = addDays(weekStartDate, -7);
    renderWeekView();
    loadAppointmentsToViews();
  });
  document.getElementById("nextWeekBtn").addEventListener("click", ()=>{
    weekStartDate = addDays(weekStartDate, 7);
    renderWeekView();
    loadAppointmentsToViews();
  });
  document.getElementById("todayWeekBtn").addEventListener("click", ()=>{
    weekStartDate = startOfWeekMonday(getTodayLocal());
    renderWeekView();
    loadAppointmentsToViews();
  });

  // ========= LOAD APPOINTMENTS into visible views =========
  function clearAllAppointmentContainers(){
    document.querySelectorAll(".day-appointments").forEach(c=>c.innerHTML="");
    document.querySelectorAll(".week-drop").forEach(c=>c.innerHTML="");
  }

  function loadAppointmentsToViews(){
    clearAllAppointmentContainers();
    const data=getAppointments();

    document.querySelectorAll(".day-cell[data-date]").forEach(cell=>{
      const iso=cell.dataset.date;
      const cont=cell.querySelector(".day-appointments");
      const arr=data[iso]||[];
      arr.forEach(a=>{
        cont.appendChild(createAppointmentEl(a.name, !!a.coded, iso));
      });
    });

    document.querySelectorAll(".week-drop[data-date]").forEach(drop=>{
      const iso=drop.dataset.date;
      const arr=data[iso]||[];
      arr.forEach(a=>{
        drop.appendChild(createAppointmentEl(a.name, !!a.coded, iso));
      });
    });
  }

  // ========= CLASSIFICA =========
  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function updateGeneralSummary(){
    const rawData=getAppointments();
    const today=getTodayLocal();
    const filter=document.getElementById("rankingYearFilter").value;

    const filteredData={};
    Object.entries(rawData).forEach(([date,apps])=>{
      const y=parseInt(String(date).slice(0,4),10);
      if(filter!=="ALL" && y!==parseInt(filter,10)) return;
      filteredData[date]=apps;
    });

    const rankingObj={};
    Object.entries(filteredData).forEach(([date,apps])=>{
      const dt=new Date(date);
      apps.forEach(a=>{
        if(!rankingObj[a.name]) rankingObj[a.name]=[];
        rankingObj[a.name].push(dt);
      });
    });

    const clients=getClients();

    const arr=clients.map(c=>{
      const dates=(rankingObj[c.name]||[]).sort((a,b)=>a-b);
      const past=dates.filter(d=>d<=today);
      const future=dates.filter(d=>d>today);

      let daysSinceLastVal=NaN;
      let daysSinceDisplay="-";
      if(past.length){
        const last=past[past.length-1];
        const diff=Math.round((today-last)/(1000*60*60*24));
        daysSinceLastVal=diff;
        daysSinceDisplay=diff+" giorni";
      }

      let progDisplay="-";
      if(future.length){
        const next=future[0];
        const missing=Math.round((next-today)/(1000*60*60*24));
        progDisplay=missing+" giorni";
      }

      const total=dates.length;
      const gap=total>1
        ? (dates.slice(1).reduce((s,d,i)=>s + Math.round((d-dates[i])/(1000*60*60*24)),0)/(total-1)).toFixed(1) + " giorni"
        : "N/A";

      const sortKey=isNaN(daysSinceLastVal) ? -Infinity : daysSinceLastVal;

      return { name:c.name, total, gap, coded:!!c.coded, daysSinceVal:sortKey, daysSinceDisplay, progDisplay };
    });

    const codedArr=arr.filter(x=>x.coded).sort((a,b)=>(b.daysSinceVal-a.daysSinceVal)||a.name.localeCompare(b.name));
    const nonArr=arr.filter(x=>!x.coded).sort((a,b)=>(b.daysSinceVal-a.daysSinceVal)||a.name.localeCompare(b.name));

    let html="";
    html += `<div class="mb-2"><span class="chip"><strong>Totale negozi:</strong> ${clients.length}</span></div>`;

    function renderCards(title, rows){
      return `
        <div class="cardx mb-3 d-block d-lg-none" style="box-shadow:none;">
          <div class="cardx-hd">
            <h6 style="font-weight:1000;margin:0;">${escapeHtml(title)}</h6>
            <span class="chip">${rows.length}</span>
          </div>
          <div class="cardx-bd" style="padding:12px;">
            <div style="display:flex;flex-direction:column;gap:10px;max-height:55dvh;overflow:auto;-webkit-overflow-scrolling:touch;">
              ${rows.map(r=>`
                <div style="border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;">
                  <div style="font-weight:1000;font-size:14px;line-height:1.15;">${escapeHtml(r.name)}</div>
                  <div class="mini muted" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:10px;">
                    <span><b>Visite:</b> ${r.total}</span>
                    <span><b>Gap:</b> ${escapeHtml(r.gap)}</span>
                    <span><b>Programmata:</b> ${escapeHtml(String(r.progDisplay))}</span>
                    <span><b>Ultima:</b> ${escapeHtml(r.daysSinceDisplay)}</span>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        </div>
      `;
    }

    function renderTable(title, rows){
      let out=`<div class="cardx mb-3 d-none d-lg-block" style="box-shadow:none;">
        <div class="cardx-hd"><h6 style="font-weight:1000;margin:0;">${escapeHtml(title)}</h6></div>
        <div class="cardx-bd" style="padding:0;">
          <div class="table-wrap" style="border:0;border-radius:0;">
            <table class="table table-sm table-bordered mb-0">
              <thead class="thead-light">
                <tr>
                  <th>Nome negozio</th>
                  <th>Visite</th>
                  <th>Gap medio</th>
                  <th>Programmata</th>
                  <th>Ultima visita</th>
                </tr>
              </thead>
              <tbody>`;
      rows.forEach(i=>{
        out += `<tr>
          <td>${escapeHtml(i.name)}</td>
          <td>${i.total}</td>
          <td>${escapeHtml(i.gap)}</td>
          <td>${escapeHtml(String(i.progDisplay))}</td>
          <td>${escapeHtml(i.daysSinceDisplay)}</td>
        </tr>`;
      });
      out += `</tbody></table></div></div></div>`;
      return out;
    }

    html += renderCards("Codificati", codedArr);
    html += renderCards("Non codificati", nonArr);
    html += renderTable("Codificati", codedArr);
    html += renderTable("Non codificati", nonArr);

    document.getElementById("generalSummary").innerHTML=html;
  }

  document.getElementById("rankingYearFilter").addEventListener("change", updateGeneralSummary);

  // ========= MODAL: Pianifica =========
  function renderMonthSelectForYear(year, selectEl){
    selectEl.innerHTML=`<option value="">Seleziona</option>`;
    (MONTHS_BY_YEAR[year]||[]).forEach(m=>{
      const opt=document.createElement("option");
      opt.value=String(m.monthNumber);
      opt.textContent=m.label;
      selectEl.appendChild(opt);
    });
  }

  function generateDayThumbnails(year, monthValue, containerEl, hiddenInputEl){
    containerEl.innerHTML="";
    hiddenInputEl.value="";
    if(!year || !monthValue) return;

    const hd=document.createElement("div");
    hd.className="thumbs-hd";
    weekdays.forEach(w=>{
      const d=document.createElement("div");
      d.textContent=w;
      hd.appendChild(d);
    });
    containerEl.appendChild(hd);

    const gd=document.createElement("div");
    gd.className="thumbs-grid";

    const mIndex0 = monthValue - 1;
    const total = daysInMonth(year, mIndex0);
    const first = weekdayMon0(year, mIndex0, 1);

    for(let i=0;i<first;i++){
      const spacer=document.createElement("div");
      gd.appendChild(spacer);
    }

    for(let d=1;d<=total;d++){
      const btn=document.createElement("button");
      btn.type="button";
      btn.textContent=d;
      btn.onclick=()=>{
        gd.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        hiddenInputEl.value=String(d);
      };
      gd.appendChild(btn);
    }
    containerEl.appendChild(gd);
  }

  function openScheduleModal(id){
    currentClientId=id;
    const client=getClientById(id);
    if(!client) return;

    document.getElementById("selectedClientName").value = client.name;

    document.getElementById("scheduleYear").value = String(selectedYear);
    renderMonthSelectForYear(selectedYear, document.getElementById("scheduleMonth"));

    document.getElementById("scheduleMonth").value="";
    document.getElementById("dayThumbnails").innerHTML="";
    document.getElementById("scheduleDay").value="";

    $('#scheduleModal').modal('show');
  }

  document.getElementById("scheduleYear").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("scheduleYear").value,10);
    renderMonthSelectForYear(y, document.getElementById("scheduleMonth"));
    document.getElementById("dayThumbnails").innerHTML="";
    document.getElementById("scheduleDay").value="";
  });

  document.getElementById("scheduleMonth").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("scheduleYear").value,10);
    const mv=parseInt(document.getElementById("scheduleMonth").value,10);
    generateDayThumbnails(y, mv, document.getElementById("dayThumbnails"), document.getElementById("scheduleDay"));
  });

  document.getElementById("scheduleForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const y=parseInt(document.getElementById("scheduleYear").value,10);
    const mv=parseInt(document.getElementById("scheduleMonth").value,10);
    const dv=parseInt(document.getElementById("scheduleDay").value,10);

    if(!y||!mv||!dv){ alert("Compila tutti i campi."); return; }

    const dateISO = `${y}-${pad2(mv)}-${pad2(dv)}`;
    const client=getClientById(currentClientId);
    if(!client){ alert("Negozio non trovato."); return; }

    const data=getAppointments();
    const arr=data[dateISO]||[];
    if(arr.length>=8){ alert("Limite di 8 appuntamenti."); return; }

    upsertAppointmentToStorage(dateISO, {name: client.name, coded: !!client.coded});

    loadAppointmentsToViews();
    updateGeneralSummary();
    $('#scheduleModal').modal('hide');
  });

  // ========= MODAL: Sposta appuntamento =========
  function openMoveModal(name, coded, fromDate){
    moving = { name, coded, fromDate };

    document.getElementById("moveClientName").value = name;

    const d = fromDate ? parseISODate(fromDate) : getTodayLocal();
    const y = d.getFullYear();
    const m = d.getMonth()+1;
    const day = d.getDate();

    document.getElementById("moveYear").value = String(y);
    renderMonthSelectForYear(y, document.getElementById("moveMonth"));
    document.getElementById("moveMonth").value = String(m);

    generateDayThumbnails(y, m, document.getElementById("moveDayThumbnails"), document.getElementById("moveDay"));

    document.getElementById("moveDay").value = String(day);
    setTimeout(()=>{
      const grid=document.querySelector("#moveDayThumbnails .thumbs-grid");
      if(grid){
        const btns=[...grid.querySelectorAll("button")];
        btns.forEach(b=>b.classList.toggle("active", b.textContent===String(day)));
      }
    }, 0);

    $('#moveModal').modal('show');
  }

  document.getElementById("openSettingsBtn").addEventListener("click", () => {
    $('#settingsModal').modal('show');
  });

  document.getElementById("moveYear").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("moveYear").value,10);
    renderMonthSelectForYear(y, document.getElementById("moveMonth"));
    document.getElementById("moveDayThumbnails").innerHTML="";
    document.getElementById("moveDay").value="";
  });

  document.getElementById("moveMonth").addEventListener("change", ()=>{
    const y=parseInt(document.getElementById("moveYear").value,10);
    const mv=parseInt(document.getElementById("moveMonth").value,10);
    generateDayThumbnails(y, mv, document.getElementById("moveDayThumbnails"), document.getElementById("moveDay"));
  });

  document.getElementById("moveForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const y=parseInt(document.getElementById("moveYear").value,10);
    const mv=parseInt(document.getElementById("moveMonth").value,10);
    const dv=parseInt(document.getElementById("moveDay").value,10);

    if(!y||!mv||!dv){ alert("Compila tutti i campi."); return; }

    const toDate = `${y}-${pad2(mv)}-${pad2(dv)}`;

    const data=getAppointments();
    const targetArr=data[toDate]||[];
    if(targetArr.length>=8){ alert("Limite di 8 appuntamenti."); return; }

    removeAppointmentFromStorage(moving.fromDate, moving.name, moving.coded);
    upsertAppointmentToStorage(toDate, {name:moving.name, coded:moving.coded});

    loadAppointmentsToViews();
    updateGeneralSummary();
    $('#moveModal').modal('hide');
  });

  // ========= INVIO (mail) =========
  function buildMailFromCurrentView(){
    let subj="", body="";

    if(activePlanningTab==="generale"){
      subj = `Pianificazione - Classifica ${currentManager}`;
      body = document.getElementById("generalSummary").innerText.trim();
      return {subj, body};
    }

    if(activePlanningTab==="settimana"){
      subj = `Pianificazione Settimana - ${document.getElementById("weekLabel").innerText} - ${currentManager}`;
      const data=getAppointments();
      const lines=[];
      for(let i=0;i<7;i++){
        const d=addDays(weekStartDate, i);
        const iso=toISODate(d);
        const arr=data[iso]||[];
        if(arr.length){
          lines.push(`${iso}: ${arr.map(x=>x.name).join(", ")}`);
        }
      }
      body = lines.length ? lines.join("\n") : "Nessuna pianificazione presente in questa settimana.";
      return {subj, body};
    }

    const monthLabel = MONTHS_BY_YEAR[selectedYear].find(m=>m.monthNumber===activeMonthNumber)?.label || "Mese";
    subj = `Pianificazione ${selectedYear} - ${monthLabel} - ${currentManager}`;

    const data=getAppointments();
    const lines=[];
    Object.keys(data)
      .filter(iso=>iso.startsWith(`${selectedYear}-${pad2(activeMonthNumber)}-`))
      .sort()
      .forEach(iso=>{
        const arr=data[iso]||[];
        if(arr.length) lines.push(`${iso}: ${arr.map(x=>x.name).join(", ")}`);
      });

    body = lines.length ? lines.join("\n") : "Nessuna pianificazione presente in questo mese.";
    return {subj, body};
  }

  function sendMail(){
    const {subj, body} = buildMailFromCurrentView();
    window.location.href=`mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  }

  document.getElementById("sendScheduleBtn").addEventListener("click", sendMail);
  document.getElementById("sendScheduleBtnTop").addEventListener("click", ()=>{
    showView("plan");
    sendMail();
  });

  // ========= CSS escape helper =========
  function cssEscape(s){
    return String(s).replace(/([!"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~])/g,'\\$1');
  }

  // ========= INIT / RELOAD =========
  function reloadAll(){
    renderAmLabel();
    syncYearChip();

    if(!activeMonthNumber){
      const bestKey=pickBestMonth(selectedYear);
      activeMonthNumber = bestKey
        ? (MONTHS_BY_YEAR[selectedYear].find(m=>m.key===bestKey)?.monthNumber || MONTHS_BY_YEAR[selectedYear][0]?.monthNumber)
        : (MONTHS_BY_YEAR[selectedYear][0]?.monthNumber);
    }
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, activeMonthNumber);
    populateMonthSelect();

    loadClients();

    rebuildPlanningTabs();
    renderActivePlanningPanel();
    loadAppointmentsToViews();
    updateGeneralSummary();
  }

  // ========= INIT =========
  document.addEventListener("DOMContentLoaded", ()=>{
    loadManagers();
    document.getElementById("managerSelect").value = currentManager;
    renderAmLabel();

    const today=getTodayLocal();
    const initYear = (today.getFullYear()===2025 || today.getFullYear()===2026) ? today.getFullYear() : 2026;
    selectedYear = initYear;
    syncYearChip();

    weekStartDate = startOfWeekMonday(today);
    activeMonthNumber = normalizeActiveMonthForYear(selectedYear, today.getMonth()+1);
    populateMonthSelect();

    // schedule modal default month list
    document.getElementById("scheduleYear").value=String(selectedYear);
    renderMonthSelectForYear(selectedYear, document.getElementById("scheduleMonth"));

    // move modal month list
    document.getElementById("moveYear").value=String(selectedYear);
    renderMonthSelectForYear(selectedYear, document.getElementById("moveMonth"));

    // initial view = portafoglio
    showView("port");
    reloadAll();

    console.assert(typeof currentManager==="string", "currentManager deve essere definito");
  });
</script>
</body>
</html>
